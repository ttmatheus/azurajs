---
title: Middleware
description: Guia completo de middleware no AzuraJS - ciclo de vida, tipos, padr√µes e melhores pr√°ticas
icon: Plug
---

# Middleware üîå

Middleware s√£o fun√ß√µes fundamentais do processamento de requisi√ß√µes no AzuraJS, permitindo interceptar, transformar e controlar o fluxo de requisi√ß√µes e respostas em sua aplica√ß√£o.

## O que √© Middleware? üìö

Middleware √© uma fun√ß√£o que executa durante o ciclo request-response, ficando entre a requisi√ß√£o recebida e seu handler de rota. Pense em middleware como uma s√©rie de camadas que toda requisi√ß√£o atravessa antes de chegar ao seu destino final.

### Assinatura do Middleware

```typescript
import type { RequestHandler } from "azurajs/types";

type RequestHandler = (
  req: RequestServer,
  res: ResponseServer,
  next: (err?: unknown) => void
) => void | Promise<void>;
```

Cada middleware tem acesso a:

- **Objeto Request** (`req`) - Ler e modificar dados de entrada
- **Objeto Response** (`res`) - Controlar a resposta
- **Fun√ß√£o Next** (`next`) - Passar controle para o pr√≥ximo middleware

### Capacidades Principais

- ‚úÖ Executar c√≥digo antes dos handlers de rota
- ‚úÖ Modificar objetos request/response
- ‚úÖ Encerrar o ciclo request-response antecipadamente
- ‚úÖ Chamar o pr√≥ximo middleware na pilha
- ‚úÖ Tratar erros globalmente
- ‚úÖ Implementar preocupa√ß√µes transversais (auth, logging, CORS, rate limiting)

## Ciclo de Vida do Middleware üîÑ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Requisi√ß√£o ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Middleware 1 (ex: Logging)             ‚îÇ
‚îÇ  - Registrar detalhes da requisi√ß√£o     ‚îÇ
‚îÇ  - Definir ID da requisi√ß√£o             ‚îÇ
‚îÇ  - Chamar next() ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
       ‚îÇ                                      ‚îÇ
       ‚ñº                                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  Middleware 2 (ex: CORS)                ‚îÇ   ‚îÇ
‚îÇ  - Definir headers CORS                 ‚îÇ   ‚îÇ
‚îÇ  - Tratar requisi√ß√µes preflight         ‚îÇ   ‚îÇ
‚îÇ  - Chamar next() ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ   ‚îÇ
       ‚îÇ                                      ‚îÇ   ‚îÇ
       ‚ñº                                      ‚îÇ   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ   ‚îÇ
‚îÇ  Middleware 3 (ex: Autentica√ß√£o)        ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ  - Verificar token                      ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ  - Anexar usu√°rio √† requisi√ß√£o          ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ  - Chamar next() ou rejeitar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ   ‚îÇ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ   ‚îÇ   ‚îÇ
       ‚îÇ                                       ‚îÇ   ‚îÇ   ‚îÇ
       ‚ñº                                       ‚îÇ   ‚îÇ   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ  Handler de Rota                        ‚îÇ    ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ  - Processar l√≥gica de neg√≥cio          ‚îÇ    ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ  - Enviar resposta                      ‚îÇ    ‚îÇ   ‚îÇ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ   ‚îÇ   ‚îÇ
       ‚îÇ                                       ‚îÇ   ‚îÇ   ‚îÇ
       ‚îÇ    Resposta flui de volta             ‚îÇ   ‚îÇ   ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ   ‚îÇ
                                                   ‚îÇ   ‚îÇ
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
       ‚îÇ                                               ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Resposta  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Tipos de Middleware üéØ

### 1. Middleware Global

Aplica a **todas as rotas** na sua aplica√ß√£o:

```typescript
import { AzuraClient } from "azurajs";

const app = new AzuraClient();

// Executa para cada requisi√ß√£o
app.use(async (req, res, next) => {
  console.log(`[${new Date().toISOString()}] ${req.method} ${req.url}`);
  await next();
});

// Adiciona header customizado a todas as respostas
app.use(async (req, res, next) => {
  res.setHeader("X-Powered-By", "AzuraJS");
  await next();
});
```

### 2. Middleware de Rota Espec√≠fica

Aplica middleware a caminhos ou grupos de rotas espec√≠ficos:

```typescript
// Aplica a todas as rotas /api/admin
app.use("/api/admin", adminAuthMiddleware);

// Aplica a todas as rotas /api/users
app.use("/api/users", rateLimitMiddleware);

// M√∫ltiplos middleware para um caminho
app.use("/api/protected", [authMiddleware, rbacMiddleware]);
```

### 3. Middleware de Tratamento de Erros

Middleware especial que envolve tudo para capturar erros:

```typescript
import { HttpError } from "azurajs/http-error";
import type { RequestHandler } from "azurajs/types";

const errorMiddleware: RequestHandler = async (req, res, next) => {
  try {
    await next();
  } catch (error: any) {
    console.error("‚ùå Erro:", error);
    
    if (error instanceof HttpError) {
      res.status(error.status).json({
        error: error.message,
        code: error.code
      });
    } else {
      res.status(500).json({
        error: "Erro interno do servidor"
      });
    }
  }
};

// Registrar middleware de erro primeiro (envolve tudo)
app.use(errorMiddleware);
```

## Criando Middleware üõ†Ô∏è

### Middleware B√°sico

#### TypeScript

```typescript
import type { RequestHandler } from "azurajs/types";

// Middleware de logging simples
const loggingMiddleware: RequestHandler = async (req, res, next) => {
  const start = Date.now();
  console.log(`‚û°Ô∏è  ${req.method} ${req.url}`);
  
  await next();
  
  const duration = Date.now() - start;
  console.log(`‚úÖ ${req.method} ${req.url} - ${duration}ms`);
};
```

#### JavaScript

```javascript
// Middleware de logging simples
const loggingMiddleware = async (req, res, next) => {
  const start = Date.now();
  console.log(`‚û°Ô∏è  ${req.method} ${req.url}`);
  
  await next();
  
  const duration = Date.now() - start;
  console.log(`‚úÖ ${req.method} ${req.url} - ${duration}ms`);
};
```

### Middleware com Configura√ß√£o

Crie fun√ß√µes factory para middleware configur√°vel:

#### TypeScript

```typescript
function createAuthMiddleware(options: { secret: string; issuer: string }): RequestHandler {
  return async (req, res, next) => {
    const token = req.headers.authorization?.replace("Bearer ", "");
    
    if (!token) {
      res.status(401).json({ error: "Token n√£o fornecido" });
      return;
    }
    
    try {
      const payload = await verifyJWT(token, options.secret, options.issuer);
      (req as any).user = payload;
      await next();
    } catch (error) {
      res.status(401).json({ error: "Token inv√°lido" });
    }
  };
}

// Uso
const authMiddleware = createAuthMiddleware({
  secret: process.env.JWT_SECRET!,
  issuer: "azurajs-app"
});

app.use(authMiddleware);
```

#### JavaScript

```javascript
function createAuthMiddleware(options) {
  return async (req, res, next) => {
    const token = req.headers.authorization?.replace("Bearer ", "");
    
    if (!token) {
      res.status(401).json({ error: "Token n√£o fornecido" });
      return;
    }
    
    try {
      const payload = await verifyJWT(token, options.secret, options.issuer);
      req.user = payload;
      await next();
    } catch (error) {
      res.status(401).json({ error: "Token inv√°lido" });
    }
  };
}

// Uso
const authMiddleware = createAuthMiddleware({
  secret: process.env.JWT_SECRET,
  issuer: "azurajs-app"
});

app.use(authMiddleware);
```

## Exemplos Pr√°ticos üí°

### 1. Middleware de Autentica√ß√£o

Verificar tokens JWT e anexar usu√°rio √† requisi√ß√£o:

```typescript
import { HttpError } from "azurajs/http-error";
import type { RequestHandler } from "azurajs/types";
import jwt from "jsonwebtoken";

export const authMiddleware: RequestHandler = async (req, res, next) => {
  const token = req.headers.authorization?.replace("Bearer ", "");
  
  if (!token) {
    res.status(401).json({ error: "Autentica√ß√£o necess√°ria" });
    return;
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as any;
    (req as any).user = {
      id: decoded.userId,
      email: decoded.email,
      role: decoded.role
    };
    await next();
  } catch (error) {
    res.status(401).json({ error: "Token inv√°lido ou expirado" });
  }
};
```

### 2. Middleware de Logging com Cores

Logging aprimorado com timing de requisi√ß√£o:

```typescript
const colors = {
  reset: "\\x1b[0m",
  green: "\\x1b[32m",
  yellow: "\\x1b[33m",
  blue: "\\x1b[34m",
  red: "\\x1b[31m"
};

const loggingMiddleware: RequestHandler = async (req, res, next) => {
  const start = Date.now();
  const timestamp = new Date().toISOString();
  
  console.log(
    `${colors.blue}[${timestamp}]${colors.reset} ` +
    `${colors.yellow}${req.method}${colors.reset} ${req.url}`
  );
  
  await next();
  
  const duration = Date.now() - start;
  const color = duration < 100 ? colors.green : duration < 500 ? colors.yellow : colors.red;
  
  console.log(
    `${colors.blue}[${timestamp}]${colors.reset} ` +
    `${colors.yellow}${req.method}${colors.reset} ${req.url} - ` +
    `${color}${duration}ms${colors.reset}`
  );
};
```

### 3. Middleware CORS

Tratar Cross-Origin Resource Sharing:

```typescript
interface CorsOptions {
  origin: string | string[];
  methods?: string[];
  allowedHeaders?: string[];
  credentials?: boolean;
  maxAge?: number;
}

function createCorsMiddleware(options: CorsOptions): RequestHandler {
  return async (req, res, next) => {
    const origin = Array.isArray(options.origin) 
      ? options.origin.join(", ")
      : options.origin;
    
    res.setHeader("Access-Control-Allow-Origin", origin);
    res.setHeader(
      "Access-Control-Allow-Methods",
      (options.methods || ["GET", "POST", "PUT", "DELETE", "PATCH"]).join(", ")
    );
    res.setHeader(
      "Access-Control-Allow-Headers",
      (options.allowedHeaders || ["Content-Type", "Authorization"]).join(", ")
    );
    
    if (options.credentials) {
      res.setHeader("Access-Control-Allow-Credentials", "true");
    }
    
    if (options.maxAge) {
      res.setHeader("Access-Control-Max-Age", String(options.maxAge));
    }
    
    // Tratar requisi√ß√µes preflight
    if (req.method === "OPTIONS") {
      res.status(204).end();
      return;
    }
    
    await next();
  };
}

// Uso
app.use(createCorsMiddleware({
  origin: ["http://localhost:3000", "https://meuapp.com"],
  methods: ["GET", "POST", "PUT", "DELETE"],
  credentials: true,
  maxAge: 86400
}));
```

### 4. Middleware de Rate Limiting

Proteja sua API de abuso:

```typescript
interface RateLimitStore {
  count: number;
  resetAt: number;
}

function createRateLimitMiddleware(
  maxRequests: number,
  windowMs: number
): RequestHandler {
  const store = new Map<string, RateLimitStore>();
  
  // Limpar entradas antigas a cada minuto
  setInterval(() => {
    const now = Date.now();
    for (const [key, value] of store.entries()) {
      if (now > value.resetAt) {
        store.delete(key);
      }
    }
  }, 60000);
  
  return async (req, res, next) => {
    const ip = req.socket.remoteAddress || "unknown";
    const now = Date.now();
    
    let record = store.get(ip);
    
    if (!record || now > record.resetAt) {
      record = { count: 1, resetAt: now + windowMs };
      store.set(ip, record);
      await next();
      return;
    }
    
    record.count++;
    
    if (record.count > maxRequests) {
      res.setHeader("X-RateLimit-Limit", String(maxRequests));
      res.setHeader("X-RateLimit-Remaining", "0");
      res.setHeader("X-RateLimit-Reset", String(record.resetAt));
      
      res.status(429).json({
        error: "Muitas requisi√ß√µes",
        retryAfter: Math.ceil((record.resetAt - now) / 1000)
      });
      return;
    }
    
    res.setHeader("X-RateLimit-Limit", String(maxRequests));
    res.setHeader("X-RateLimit-Remaining", String(maxRequests - record.count));
    res.setHeader("X-RateLimit-Reset", String(record.resetAt));
    
    await next();
  };
}

// Uso: 100 requisi√ß√µes por minuto
app.use(createRateLimitMiddleware(100, 60000));
```

### 5. Middleware de Timing de Requisi√ß√£o

Adicionar header de tempo de resposta:

```typescript
const timingMiddleware: RequestHandler = async (req, res, next) => {
  const start = process.hrtime.bigint();
  
  await next();
  
  const end = process.hrtime.bigint();
  const duration = Number(end - start) / 1000000; // Converter para milissegundos
  
  res.setHeader("X-Response-Time", `${duration.toFixed(2)}ms`);
};
```

### 6. Middleware de Request ID

Rastrear requisi√ß√µes com IDs √∫nicos:

```typescript
import { randomUUID } from "crypto";

const requestIdMiddleware: RequestHandler = async (req, res, next) => {
  const requestId = req.headers["x-request-id"] || randomUUID();
  
  (req as any).id = requestId;
  res.setHeader("X-Request-ID", requestId);
  
  await next();
};
```

### 7. Middleware de Limite de Tamanho de Body

Prevenir ataques de payload grande:

```typescript
function createBodySizeLimitMiddleware(maxSize: number): RequestHandler {
  return async (req, res, next) => {
    const contentLength = parseInt(req.headers["content-length"] || "0", 10);
    
    if (contentLength > maxSize) {
      res.status(413).json({
        error: "Payload muito grande",
        maxSize,
        received: contentLength
      });
      return;
    }
    
    await next();
  };
}

// Uso: Limite de 10MB
app.use(createBodySizeLimitMiddleware(10 * 1024 * 1024));
```

### 8. Middleware de Compress√£o

Comprimir respostas para economizar banda:

```typescript
import { gzipSync, brotliCompressSync } from "zlib";

const compressionMiddleware: RequestHandler = async (req, res, next) => {
  const acceptEncoding = req.headers["accept-encoding"] || "";
  
  // Armazenar m√©todo send original
  const originalSend = res.send?.bind(res);
  
  if (!originalSend) {
    await next();
    return;
  }
  
  // Sobrescrever m√©todo send
  res.send = function(data: any) {
    if (typeof data !== "string" && !Buffer.isBuffer(data)) {
      return originalSend(data);
    }
    
    const buffer = Buffer.isBuffer(data) ? data : Buffer.from(data);
    
    // Comprimir apenas se tamanho > 1KB
    if (buffer.length < 1024) {
      return originalSend(data);
    }
    
    if (acceptEncoding.includes("br")) {
      const compressed = brotliCompressSync(buffer);
      res.setHeader("Content-Encoding", "br");
      return originalSend(compressed);
    } else if (acceptEncoding.includes("gzip")) {
      const compressed = gzipSync(buffer);
      res.setHeader("Content-Encoding", "gzip");
      return originalSend(compressed);
    }
    
    return originalSend(data);
  };
  
  await next();
};
```

## Ordem de Execu√ß√£o e Preced√™ncia ‚ö°

Middleware executa na ordem em que √© registrado:

```typescript
const app = new AzuraClient();

// 1. Wrapper de erro (primeiro para capturar tudo)
app.use(errorMiddleware);

// 2. Request ID
app.use(requestIdMiddleware);

// 3. Timing
app.use(timingMiddleware);

// 4. Logging
app.use(loggingMiddleware);

// 5. Compress√£o
app.use(compressionMiddleware);

// 6. CORS
app.use(corsMiddleware);

// 7. Limite de tamanho de body
app.use(createBodySizeLimitMiddleware(10 * 1024 * 1024));

// 8. Rate limiting
app.use(createRateLimitMiddleware(100, 60000));

// 9. Autentica√ß√£o (opcional para algumas rotas)
app.use(conditionalAuthMiddleware);

// 10. Suas rotas
applyDecorators(app, [UserController, ProductController]);

// A ordem garante:
// - Erros s√£o capturados primeiro
// - Requisi√ß√µes s√£o registradas com IDs
// - Rate limiting antes de processamento pesado
// - Auth por √∫ltimo antes das rotas
```

## Padr√µes de Middleware Customizado üé®

### Middleware Condicional

Aplicar middleware baseado em condi√ß√µes:

```typescript
const conditionalAuthMiddleware: RequestHandler = async (req, res, next) => {
  // Pular auth para rotas p√∫blicas
  const publicRoutes = ["/api/public", "/health", "/metrics"];
  
  if (publicRoutes.some(route => req.url?.startsWith(route))) {
    await next();
    return;
  }
  
  // Aplicar auth para outras rotas
  await authMiddleware(req, res, next);
};
```

### Composi√ß√£o de Middleware

Combinar m√∫ltiplos middleware:

```typescript
function composeMiddleware(...middlewares: RequestHandler[]): RequestHandler {
  return async (req, res, next) => {
    let index = 0;
    
    const dispatch = async (): Promise<void> => {
      if (index >= middlewares.length) {
        await next();
        return;
      }
      
      const middleware = middlewares[index++];
      await middleware(req, res, dispatch);
    };
    
    await dispatch();
  };
}

// Uso
const protectedRoute = composeMiddleware(
  authMiddleware,
  rbacMiddleware,
  auditMiddleware
);

app.use("/api/admin", protectedRoute);
```

## Compatibilidade com Middleware Express üîÑ

Middleware do AzuraJS √© compat√≠vel com middleware Express:

```typescript
import helmet from "helmet";
import compression from "compression";
import cookieParser from "cookie-parser";

const app = new AzuraClient();

// Usar middleware Express diretamente
app.use(helmet());
app.use(compression());
app.use(cookieParser());
```

## Tratamento de Erros em Middleware ‚ö†Ô∏è

### Padr√£o Try-Catch

```typescript
const safeMiddleware: RequestHandler = async (req, res, next) => {
  try {
    // Sua l√≥gica de middleware
    const data = await fetchExternalData();
    (req as any).externalData = data;
    await next();
  } catch (error) {
    console.error("Erro no middleware:", error);
    res.status(500).json({ error: "Middleware falhou" });
  }
};
```

### Propaga√ß√£o de Erros

Passar erros para middleware de tratamento de erro:

```typescript
const middlewareWithErrors: RequestHandler = async (req, res, next) => {
  try {
    const user = await database.getUser(userId);
    if (!user) {
      throw new HttpError(404, "Usu√°rio n√£o encontrado");
    }
    (req as any).user = user;
    await next();
  } catch (error) {
    // Erro ser√° capturado pelo middleware de erro
    throw error;
  }
};
```

## Padr√µes de Middleware Async üîÑ

### Opera√ß√µes Async Sequenciais

```typescript
const dataFetchMiddleware: RequestHandler = async (req, res, next) => {
  try {
    // Executar sequencialmente
    const user = await database.getUser(userId);
    const permissions = await database.getPermissions(user.id);
    const settings = await database.getSettings(user.id);
    
    (req as any).user = user;
    (req as any).permissions = permissions;
    (req as any).settings = settings;
    
    await next();
  } catch (error) {
    res.status(500).json({ error: "Falha ao buscar dados" });
  }
};
```

### Opera√ß√µes Async Paralelas

```typescript
const parallelDataMiddleware: RequestHandler = async (req, res, next) => {
  try {
    // Executar em paralelo para melhor performance
    const [user, permissions, settings] = await Promise.all([
      database.getUser(userId),
      database.getPermissions(userId),
      database.getSettings(userId)
    ]);
    
    (req as any).user = user;
    (req as any).permissions = permissions;
    (req as any).settings = settings;
    
    await next();
  } catch (error) {
    res.status(500).json({ error: "Falha ao buscar dados" });
  }
};
```

## Melhores Pr√°ticas e Dicas de Performance üíé

### 1. Sempre Chame `next()`

```typescript
// ‚ùå Ruim - requisi√ß√£o trava
const badMiddleware: RequestHandler = async (req, res, next) => {
  console.log("Processando...");
  // Esqueceu de chamar next()!
};

// ‚úÖ Bom
const goodMiddleware: RequestHandler = async (req, res, next) => {
  console.log("Processando...");
  await next(); // Sempre chame next
};
```

### 2. Use Async/Await

```typescript
// ‚ùå Ruim - sem await
const badMiddleware: RequestHandler = async (req, res, next) => {
  fetchData().then(() => next()); // Promise n√£o aguardada
};

// ‚úÖ Bom
const goodMiddleware: RequestHandler = async (req, res, next) => {
  await fetchData();
  await next();
};
```

### 3. Ordem Importa

```typescript
// ‚ùå Ruim - auth antes de CORS
app.use(authMiddleware);  // Pode falhar em OPTIONS
app.use(corsMiddleware);

// ‚úÖ Bom - CORS primeiro
app.use(corsMiddleware);  // Tratar OPTIONS primeiro
app.use(authMiddleware);
```

### 4. Mantenha Middleware Focado

```typescript
// ‚ùå Ruim - fazendo muito
const godMiddleware: RequestHandler = async (req, res, next) => {
  // Logging, auth, valida√ß√£o, transforma√ß√£o...
  // 100 linhas de c√≥digo
};

// ‚úÖ Bom - responsabilidade √∫nica
const loggingMiddleware: RequestHandler = async (req, res, next) => {
  console.log(req.method, req.url);
  await next();
};

const authMiddleware: RequestHandler = async (req, res, next) => {
  await verifyAuth(req);
  await next();
};
```

### 5. Use Cache para Opera√ß√µes Caras

```typescript
const cache = new Map<string, any>();

const cachedMiddleware: RequestHandler = async (req, res, next) => {
  const key = req.url;
  
  if (cache.has(key)) {
    (req as any).cached = cache.get(key);
    await next();
    return;
  }
  
  const data = await expensiveOperation();
  cache.set(key, data);
  (req as any).cached = data;
  
  await next();
};
```

### 6. Limpe Recursos

```typescript
const resourceMiddleware: RequestHandler = async (req, res, next) => {
  const connection = await database.connect();
  
  try {
    (req as any).db = connection;
    await next();
  } finally {
    // Sempre limpar
    await connection.close();
  }
};
```

## Testando Middleware üß™

### Testes Unit√°rios

```typescript
import { describe, it, expect, mock } from "bun:test";

describe("Auth Middleware", () => {
  it("deve rejeitar requisi√ß√µes sem token", async () => {
    const req = {
      headers: {}
    } as any;
    
    const res = {
      status: mock((code: number) => res),
      json: mock((data: any) => res)
    } as any;
    
    const next = mock(async () => {});
    
    await authMiddleware(req, res, next);
    
    expect(res.status).toHaveBeenCalledWith(401);
    expect(res.json).toHaveBeenCalledWith({ error: "Autentica√ß√£o necess√°ria" });
    expect(next).not.toHaveBeenCalled();
  });
  
  it("deve aceitar tokens v√°lidos", async () => {
    const req = {
      headers: {
        authorization: "Bearer valid-token"
      }
    } as any;
    
    const res = {} as any;
    const next = mock(async () => {});
    
    await authMiddleware(req, res, next);
    
    expect(req.user).toBeDefined();
    expect(next).toHaveBeenCalled();
  });
});
```

## Solucionando Problemas Comuns üîß

### Problema: Requisi√ß√£o Trava

**Causa**: Esqueceu de chamar `next()`

```typescript
// ‚ùå Ruim
const middleware: RequestHandler = async (req, res, next) => {
  console.log("Processando...");
  // Esqueceu next()!
};

// ‚úÖ Corre√ß√£o
const middleware: RequestHandler = async (req, res, next) => {
  console.log("Processando...");
  await next();
};
```

### Problema: Headers J√° Enviados

**Causa**: Chamando `res.json()` antes de `next()`

```typescript
// ‚ùå Ruim
const middleware: RequestHandler = async (req, res, next) => {
  res.json({ data: "algo" });
  await next(); // Headers j√° enviados!
};

// ‚úÖ Corre√ß√£o
const middleware: RequestHandler = async (req, res, next) => {
  if (someCondition) {
    res.json({ data: "algo" });
    return; // N√£o chamar next
  }
  await next();
};
```

### Problema: Middleware N√£o Executa

**Causa**: Registrado depois das rotas

```typescript
// ‚ùå Ruim
applyDecorators(app, [Controllers]);
app.use(middleware); // Muito tarde!

// ‚úÖ Corre√ß√£o
app.use(middleware);
applyDecorators(app, [Controllers]);
```

## Exemplo Completo: Setup Pronto para Produ√ß√£o üöÄ

```typescript
import { AzuraClient } from "azurajs";
import { applyDecorators } from "azurajs/decorators";
import type { RequestHandler } from "azurajs/types";

const app = new AzuraClient();

// 1. Wrapper de tratamento de erros
app.use(errorMiddleware);

// 2. Request ID e timing
app.use(requestIdMiddleware);
app.use(timingMiddleware);

// 3. Logging
app.use(loggingMiddleware);

// 4. Seguran√ßa
app.use(createCorsMiddleware({
  origin: process.env.ALLOWED_ORIGINS!.split(","),
  credentials: true
}));

app.use(helmet());

// 5. Limite de tamanho de body
app.use(createBodySizeLimitMiddleware(10 * 1024 * 1024));

// 6. Rate limiting
app.use(createRateLimitMiddleware(100, 60000));

// 7. Compress√£o
app.use(compressionMiddleware);

// 8. Auth condicional
app.use(conditionalAuthMiddleware);

// 9. Suas rotas
applyDecorators(app, [
  UserController,
  ProductController,
  OrderController
]);

// Iniciar servidor
app.listen(3000, () => {
  console.log("üöÄ Servidor rodando em http://localhost:3000");
});
```

## Pr√≥ximos Passos üìñ

Agora que voc√™ entende middleware, explore estes t√≥picos relacionados:

- [**Valida√ß√£o**](validation) - Validar dados de requisi√ß√£o com middleware
- [**Cookies**](cookies) - Manipular cookies em middleware
- [**Tratamento de Erros**](error-handling) - Padr√µes avan√ßados de tratamento de erros
- [**CORS**](cors) - Mergulho profundo em configura√ß√£o CORS

---

**Dica Pro**: A ordem do middleware √© crucial. Coloque tratamento de erros primeiro, logging segundo, seguran√ßa terceiro e autentica√ß√£o por √∫ltimo antes de suas rotas.
