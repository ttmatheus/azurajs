---
title: CORS (Cross-Origin Resource Sharing)
description: Complete guide to configuring and securing CORS in AzuraJS applications
icon: Globe
---

# CORS (Cross-Origin Resource Sharing) ðŸŒ

Cross-Origin Resource Sharing (CORS) is a critical security mechanism that controls which domains can access your API from browsers. Understanding and properly configuring CORS is essential for building secure web applications.

## What is CORS? ðŸ¤”

CORS is a browser security mechanism that restricts web pages from making requests to a different domain than the one serving the web page. Without proper CORS configuration, your API would be completely inaccessible to frontend applications hosted on different domains.

### Why CORS Exists

**Same-Origin Policy**: Browsers enforce this security policy by default to prevent malicious websites from stealing sensitive data. For example, without CORS, a malicious website could make requests to your banking API using your existing session cookies.

**Real-World Example**:
```
Your API:      https://api.example.com
Your Frontend: https://app.example.com
Attacker:      https://malicious-site.com

Without CORS:
âœ… app.example.com â†’ api.example.com (Allowed - needs CORS)
âŒ malicious-site.com â†’ api.example.com (Blocked - protection!)

With CORS Configured:
âœ… app.example.com â†’ api.example.com (Allowed via CORS headers)
âŒ malicious-site.com â†’ api.example.com (Still blocked!)
```

### CORS Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      1. Preflight        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚ â”€â”€â”€â”€OPTIONS Requestâ”€â”€â”€â”€> â”‚   API Server â”‚
â”‚             â”‚                           â”‚              â”‚
â”‚ app.example â”‚ <â”€â”€â”€Access-Control-*â”€â”€â”€â”€ â”‚ api.example  â”‚
â”‚    .com     â”‚    Headers in 204        â”‚    .com      â”‚
â”‚             â”‚                           â”‚              â”‚
â”‚             â”‚ 2. Actual Request        â”‚              â”‚
â”‚             â”‚ â”€â”€â”€â”€GET/POST/PUTâ”€â”€â”€â”€â”€â”€â”€â”€> â”‚              â”‚
â”‚             â”‚    + Origin Header        â”‚              â”‚
â”‚             â”‚                           â”‚              â”‚
â”‚             â”‚ <â”€â”€â”€Response withâ”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
â”‚             â”‚    CORS Headers           â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

<Callout type="info">
**Key Point**: CORS is enforced by the **browser**, not the server. Command-line tools like `curl` or Postman don't enforce CORS, which is why APIs work in Postman but fail in the browser!
</Callout>

## How CORS Works ðŸ”„

### Simple Requests

Simple requests don't trigger preflight:
- Methods: `GET`, `HEAD`, `POST`
- Headers: `Accept`, `Accept-Language`, `Content-Language`, `Content-Type` (only `application/x-www-form-urlencoded`, `multipart/form-data`, `text/plain`)

### Preflight Requests

Complex requests require preflight (OPTIONS):
- Custom headers (e.g., `Authorization`, `X-API-Key`)
- Methods: `PUT`, `DELETE`, `PATCH`
- Content-Type: `application/json`

## CORS Headers Reference ðŸ“‹

| Header | Purpose | Example |
|--------|---------|----------|
| `Access-Control-Allow-Origin` | Allowed origins | `https://app.example.com` |
| `Access-Control-Allow-Methods` | Allowed HTTP methods | `GET, POST, PUT, DELETE` |
| `Access-Control-Allow-Headers` | Allowed request headers | `Content-Type, Authorization` |
| `Access-Control-Allow-Credentials` | Allow cookies/auth | `true` |
| `Access-Control-Expose-Headers` | Headers visible to JS | `X-Total-Count` |
| `Access-Control-Max-Age` | Preflight cache time | `86400` (24 hours) |

## Built-in CORS Plugin ðŸ”§

AzuraJS includes a ready-to-use CORS plugin:

```typescript title="azura.config.ts"
import type { ConfigTypes } from "azurajs/config";

const config: ConfigTypes = {
  plugins: {
    cors: {
      enabled: true,
      origins: ["https://app.example.com"],
      methods: ["GET", "POST", "PUT", "DELETE"],
      allowedHeaders: ["Content-Type", "Authorization"],
      exposedHeaders: ["X-Total-Count", "X-Page-Number"],
      credentials: true,
      maxAge: 86400  // 24 hours
    },
  },
};

export default config;
```

## Configuration for Different Environments ðŸ—ï¸

### Development Environment

```typescript
const developmentConfig: ConfigTypes = {
  plugins: {
    cors: {
      enabled: true,
      origins: ["*"],  // Allow all during development
      methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"],
      allowedHeaders: ["*"],
      credentials: false
    }
  }
};
```

### Staging Environment

```typescript
const stagingConfig: ConfigTypes = {
  plugins: {
    cors: {
      enabled: true,
      origins: [
        "https://staging.example.com",
        "https://preview.example.com"
      ],
      methods: ["GET", "POST", "PUT", "DELETE"],
      allowedHeaders: ["Content-Type", "Authorization"],
      credentials: true,
      maxAge: 3600  // 1 hour
    }
  }
};
```

### Production Environment

```typescript
const productionConfig: ConfigTypes = {
  plugins: {
    cors: {
      enabled: true,
      origins: [
        "https://example.com",
        "https://www.example.com",
        "https://app.example.com"
      ],
      methods: ["GET", "POST", "PUT", "DELETE"],
      allowedHeaders: ["Content-Type", "Authorization", "X-API-Key"],
      exposedHeaders: ["X-Total-Count", "X-RateLimit-Remaining"],
      credentials: true,
      maxAge: 86400  // 24 hours - reduce OPTIONS requests
    }
  }
};
```

### Environment-Based Configuration

```typescript
const getConfig = (): ConfigTypes => {
  const env = process.env.NODE_ENV;
  
  const corsOrigins = {
    development: ["*"],
    staging: ["https://staging.example.com"],
    production: ["https://example.com", "https://app.example.com"]
  };
  
  return {
    plugins: {
      cors: {
        enabled: true,
        origins: corsOrigins[env] || corsOrigins.development,
        methods: ["GET", "POST", "PUT", "DELETE"],
        allowedHeaders: ["Content-Type", "Authorization"],
        credentials: env !== "development",
        maxAge: env === "production" ? 86400 : 3600
      }
    }
  };
};

export default getConfig();
```

## Dynamic vs Static Origins ðŸŽ¯

### Static Origins (Recommended for Production)

```typescript
// Hardcoded list - most secure
cors: {
  origins: [
    "https://example.com",
    "https://app.example.com"
  ]
}
```

### Dynamic Origins with Validation

```typescript
import type { RequestHandler } from "azurajs/types";

const allowedDomains = ["example.com", "app.example.com"];

export const dynamicCorsMiddleware: RequestHandler = async (req, res, next) => {
  const origin = req.headers.origin;
  
  if (origin) {
    try {
      const url = new URL(origin);
      
      // Check if domain is allowed
      if (allowedDomains.includes(url.hostname)) {
        res.setHeader("Access-Control-Allow-Origin", origin);
        res.setHeader("Access-Control-Allow-Credentials", "true");
      }
    } catch (error) {
      // Invalid origin URL
      console.warn("Invalid origin:", origin);
    }
  }
  
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  
  if (req.method === "OPTIONS") {
    res.status(204).end();
    return;
  }
  
  await next();
};
```

### Subdomain Support

```typescript
export const subdomainCorsMiddleware: RequestHandler = async (req, res, next) => {
  const origin = req.headers.origin;
  
  if (origin) {
    // Allow all subdomains of example.com
    const allowedPattern = /^https:\/\/([a-z0-9-]+\.)?example\.com$/;
    
    if (allowedPattern.test(origin)) {
      res.setHeader("Access-Control-Allow-Origin", origin);
      res.setHeader("Access-Control-Allow-Credentials", "true");
    }
  }
  
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  
  if (req.method === "OPTIONS") {
    res.status(204).end();
    return;
  }
  
  await next();
};
```

## Credentials and Cookies ðŸ”

### Why Credentials Matter

When sending cookies, authentication tokens, or TLS client certificates:

```typescript
// Frontend - sending credentials
fetch("https://api.example.com/user", {
  credentials: "include",  // Send cookies
  headers: {
    "Authorization": "Bearer token"
  }
});
```

### Backend Configuration for Credentials

```typescript
import type { RequestHandler } from "azurajs/types";

export const corsWithCredentials: RequestHandler = async (req, res, next) => {
  const origin = req.headers.origin;
  
  // CRITICAL: Must specify exact origin, not "*"
  const allowedOrigins = [
    "https://app.example.com",
    "https://admin.example.com"
  ];
  
  if (origin && allowedOrigins.includes(origin)) {
    res.setHeader("Access-Control-Allow-Origin", origin);
    res.setHeader("Access-Control-Allow-Credentials", "true");
  }
  
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  
  if (req.method === "OPTIONS") {
    res.status(204).end();
    return;
  }
  
  await next();
};
```

<Callout type="warn">
**NEVER use "*" with credentials** - Browsers will block the request for security reasons
</Callout>

### Complete Cookie Example

```typescript
import { AzuraClient } from "azurajs";
import { Controller, Get, Post, Body, Req, Res } from "azurajs/decorators";
import type { RequestServer, ResponseServer } from "azurajs/types";

const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origins: ["https://app.example.com"],
      credentials: true,
      allowedHeaders: ["Content-Type", "Authorization"]
    }
  }
});

@Controller("/auth")
export class AuthController {
  @Post("/login")
  async login(
    @Body() credentials: { email: string; password: string },
    @Res() res: ResponseServer
  ) {
    const user = await authenticateUser(credentials);
    
    if (!user) {
      return res.status(401).json({ error: "Invalid credentials" });
    }
    
    // Set HTTP-only cookie
    res.setHeader("Set-Cookie", [
      `session=${user.sessionId}; HttpOnly; Secure; SameSite=None; Path=/; Max-Age=86400`
    ]);
    
    res.json({ user: { id: user.id, name: user.name } });
  }
  
  @Get("/me")
  async getCurrentUser(@Req() req: RequestServer, @Res() res: ResponseServer) {
    const sessionId = parseCookie(req.headers.cookie, "session");
    
    if (!sessionId) {
      return res.status(401).json({ error: "Not authenticated" });
    }
    
    const user = await getUserBySession(sessionId);
    res.json({ user });
  }
}
```

## Practical Examples ðŸŽ¯

### Single Page Application (SPA)

```typescript
// API Server
const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origins: [
        "https://app.example.com",
        "https://www.example.com"
      ],
      methods: ["GET", "POST", "PUT", "DELETE"],
      allowedHeaders: ["Content-Type", "Authorization"],
      credentials: true,
      maxAge: 86400
    }
  }
});

// Frontend (React/Vue/Angular)
const api = {
  async getUsers() {
    const response = await fetch("https://api.example.com/users", {
      method: "GET",
      credentials: "include",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      }
    });
    return response.json();
  }
};
```

### Mobile App API

```typescript
// More relaxed CORS for mobile apps
const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origins: ["*"],  // Mobile apps don't send Origin header
      methods: ["GET", "POST", "PUT", "DELETE"],
      allowedHeaders: [
        "Content-Type",
        "Authorization",
        "X-Device-ID",
        "X-App-Version"
      ],
      credentials: false  // Use token-based auth instead
    }
  }
});
```

### Microservices Architecture

```typescript
// Gateway API
const gatewayApp = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origins: ["https://app.example.com"],
      methods: ["GET", "POST", "PUT", "DELETE"],
      allowedHeaders: ["Content-Type", "Authorization"],
      credentials: true
    }
  }
});

// Internal microservice (no CORS needed)
const internalApp = new AzuraClient({
  plugins: {
    cors: {
      enabled: false  // Internal service-to-service communication
    }
  }
});
```

### Public API with Rate Limiting

```typescript
import type { RequestHandler } from "azurajs/types";

// CORS for public endpoints
export const publicCorsMiddleware: RequestHandler = async (req, res, next) => {
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "GET");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, X-API-Key");
  res.setHeader("Access-Control-Expose-Headers", "X-RateLimit-Limit, X-RateLimit-Remaining");
  
  if (req.method === "OPTIONS") {
    res.status(204).end();
    return;
  }
  
  await next();
};

app.use("/api/public", publicCorsMiddleware);
```

## Troubleshooting Common CORS Errors ðŸ”§

### Error: "No 'Access-Control-Allow-Origin' header"

**Problem**: Server doesn't send CORS headers

```typescript
// âŒ Bad - CORS not configured
const app = new AzuraClient();

// âœ… Good - CORS configured
const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origins: ["https://app.example.com"]
    }
  }
});
```

### Error: "Credential is not supported if origin is '*'"

**Problem**: Using wildcard with credentials

```typescript
// âŒ Bad
cors: {
  origins: ["*"],
  credentials: true  // Error!
}

// âœ… Good
cors: {
  origins: ["https://app.example.com"],
  credentials: true
}
```

### Error: "Header 'X-Custom-Header' not allowed"

**Problem**: Custom header not in allowed list

```typescript
// âŒ Bad - header not allowed
cors: {
  allowedHeaders: ["Content-Type"]
}

// âœ… Good - include custom header
cors: {
  allowedHeaders: ["Content-Type", "X-Custom-Header", "Authorization"]
}
```

### Error: "Method PUT not allowed"

**Problem**: HTTP method not in allowed list

```typescript
// âŒ Bad - PUT not allowed
cors: {
  methods: ["GET", "POST"]
}

// âœ… Good - include all needed methods
cors: {
  methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
}
```

### Preflight Cache Issues

**Problem**: Browser caches old CORS configuration

```typescript
// Add max-age to control cache
cors: {
  maxAge: 86400  // Cache for 24 hours
}

// To debug: Clear browser cache or use incognito mode
```

### Debugging CORS Middleware

```typescript
import type { RequestHandler } from "azurajs/types";

export const debugCorsMiddleware: RequestHandler = async (req, res, next) => {
  console.log("CORS Debug:", {
    method: req.method,
    origin: req.headers.origin,
    path: req.url,
    headers: req.headers
  });
  
  const origin = req.headers.origin || "*";
  res.setHeader("Access-Control-Allow-Origin", origin);
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  res.setHeader("Access-Control-Allow-Credentials", "true");
  
  if (req.method === "OPTIONS") {
    console.log("Preflight request handled");
    res.status(204).end();
    return;
  }
  
  await next();
};
```

## Testing CORS Configuration ðŸ§ª

### Browser DevTools Testing

```javascript
// Test from browser console
fetch('https://api.example.com/users', {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_TOKEN'
  },
  credentials: 'include'
})
.then(res => res.json())
.then(data => console.log('Success:', data))
.catch(err => console.error('CORS Error:', err));
```

### Debugging CORS Issues

**Check these in Browser Network Tab:**
1. Look for failed requests with CORS error
2. Check Response Headers for `Access-Control-*` headers
3. Verify preflight OPTIONS request succeeded (204 status)
4. Confirm Origin header matches allowed origins

### CORS Test HTML Page

```html
<!DOCTYPE html>
<html>
<head><title>CORS Test</title></head>
<body>
  <h1>Test CORS Configuration</h1>
  <button onclick="testCORS()">Test API Request</button>
  <pre id="result"></pre>
  
  <script>
    async function testCORS() {
      const result = document.getElementById('result');
      try {
        const response = await fetch('https://api.example.com/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ test: true })
        });
        const data = await response.json();
        result.textContent = 'Success: ' + JSON.stringify(data, null, 2);
      } catch (error) {
        result.textContent = 'Error: ' + error.message;
      }
    }
  </script>
</body>
</html>
```

## Performance Optimization âš¡

### Caching Preflight Requests

```typescript
const app = new AzuraClient({
  plugins: {
    cors: {
      enabled: true,
      origins: ["https://app.example.com"],
      maxAge: 86400  // Cache preflight for 24 hours = 99% fewer OPTIONS requests
    }
  }
});
```

**Benefits:**
- Reduces server load significantly
- Faster subsequent requests
- Better user experience

**Trade-offs:**
- Changes to CORS config require cache expiry
- Use lower `maxAge` during development (600 = 10 minutes)

## Security Best Practices ðŸ”’

<Callout type="warn">
**Never use "*" in production with sensitive data** - Always specify exact origins
</Callout>

<Callout type="warn">
**Don't use "*" with credentials** - Browsers will reject the request
</Callout>

<Callout type="tip">
**Use HTTPS in production** - CORS with credentials requires secure connections
</Callout>

<Callout type="tip">
**Whitelist only necessary headers** - Don't expose internal headers
</Callout>

<Callout type="tip">
**Cache preflight requests** - Use `maxAge` to reduce OPTIONS requests
</Callout>

<Callout type="info">
**Log CORS violations** - Monitor blocked requests to detect issues
</Callout>

### Security Checklist âœ…

```typescript
// Production-ready CORS configuration
const productionCors = {
  // âœ… Specific origins only
  origins: [
    "https://example.com",
    "https://www.example.com",
    "https://app.example.com"
  ],
  
  // âœ… Only necessary methods
  methods: ["GET", "POST", "PUT", "DELETE"],
  
  // âœ… Only required headers
  allowedHeaders: ["Content-Type", "Authorization"],
  
  // âœ… Don't expose sensitive headers
  exposedHeaders: ["X-Total-Count"],
  
  // âœ… Enable credentials if needed
  credentials: true,
  
  // âœ… Cache preflight for 24 hours
  maxAge: 86400
};
```

## Production Checklist ðŸ“‹

- [ ] Remove "*" from origins
- [ ] Use HTTPS for all origins
- [ ] Enable credentials only if needed
- [ ] Whitelist only necessary headers
- [ ] Set appropriate maxAge for preflight cache
- [ ] Log CORS errors for monitoring
- [ ] Test with actual frontend application
- [ ] Verify cookie/session handling
- [ ] Check subdomain support if needed
- [ ] Configure different CORS for different routes
- [ ] Test OPTIONS preflight requests
- [ ] Verify exposed headers are accessible

## Advanced Patterns ðŸš€

### Per-Route CORS Configuration

```typescript
import { AzuraClient } from "azurajs";
import type { RequestHandler } from "azurajs/types";

const app = new AzuraClient();

// Public API - open CORS
const publicCors: RequestHandler = async (req, res, next) => {
  res.setHeader("Access-Control-Allow-Origin", "*");
  res.setHeader("Access-Control-Allow-Methods", "GET");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");
  
  if (req.method === "OPTIONS") {
    res.status(204).end();
    return;
  }
  
  await next();
};

// Private API - restricted CORS
const privateCors: RequestHandler = async (req, res, next) => {
  const origin = req.headers.origin;
  const allowedOrigins = ["https://app.example.com", "https://admin.example.com"];
  
  if (origin && allowedOrigins.includes(origin)) {
    res.setHeader("Access-Control-Allow-Origin", origin);
    res.setHeader("Access-Control-Allow-Credentials", "true");
  }
  
  res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
  
  if (req.method === "OPTIONS") {
    res.status(204).end();
    return;
  }
  
  await next();
};

app.use("/api/public", publicCors);
app.use("/api/private", privateCors);
```

### CORS with Authentication Levels

```typescript
function createAuthenticatedCors(allowedOrigins: string[]): RequestHandler {
  return async (req, res, next) => {
    const origin = req.headers.origin;
    const token = req.headers.authorization;
    
    // Check authentication
    if (!token) {
      res.status(401).json({ error: "Authentication required" });
      return;
    }
    
    // Verify token and origin
    if (origin && allowedOrigins.includes(origin)) {
      res.setHeader("Access-Control-Allow-Origin", origin);
      res.setHeader("Access-Control-Allow-Credentials", "true");
    } else {
      res.status(403).json({ error: "Origin not allowed" });
      return;
    }
    
    res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE");
    res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization");
    
    if (req.method === "OPTIONS") {
      res.status(204).end();
      return;
    }
    
    await next();
  };
}
```

## Next Steps ðŸ“š

<Cards>
  <Card title="Rate Limiting" href="/docs/rate-limiting" description="Protect your API from abuse" />
  <Card title="Error Handling" href="/docs/error-handling" description="Handle errors gracefully" />
  <Card title="Middleware" href="/docs/middleware" description="Create custom middleware" />
  <Card title="Security" href="/docs/security" description="Security best practices" />
</Cards>
