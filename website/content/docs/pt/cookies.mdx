---
title: Cookies
description: Guia completo de gerenciamento de cookies - seguranÃ§a, autenticaÃ§Ã£o, sessÃµes, conformidade GDPR e melhores prÃ¡ticas
icon: Cookie
---

# Cookies ðŸª

AzuraJS fornece um sistema poderoso e seguro de gerenciamento de cookies com assinatura, criptografia, suporte a sessÃµes e recursos compatÃ­veis com GDPR - indo alÃ©m do Express com mais seguranÃ§a e flexibilidade.

## InÃ­cio RÃ¡pido ðŸš€

```typescript
import { CookieJar, SessionManager, MemorySessionStore, CookiePresets } from 'azurajs/cookies';

// Uso simples de cookie
const jar = new CookieJar();
const cookie = jar.set('user_id', '123', {
  httpOnly: true,
  secure: true,
  maxAge: 3600 // 1 hora
});

res.setHeader('Set-Cookie', cookie);
```

## Como Cookies Funcionam ðŸ“š

### O Ciclo de Vida do Cookie

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Navegador  â”‚                           â”‚   Servidor  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                         â”‚
       â”‚ 1. RequisiÃ§Ã£o Inicial                   â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                         â”‚
       â”‚ 2. Resposta + Header Set-Cookie         â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚ (Navegador armazena cookie)             â”‚
       â”‚                                         â”‚
       â”‚ 3. RequisiÃ§Ãµes Subsequentes + Cookie    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚ (Cookie enviado automaticamente)        â”‚
       â”‚                                         â”‚
       â”‚ 4. Resposta (usa dados do cookie)       â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                         â”‚
```

### O Que SÃ£o Cookies?

Cookies sÃ£o pequenos pedaÃ§os de dados (mÃ¡x 4KB) que:
- **Armazenados no lado do cliente** - Navegador armazena cookies por domÃ­nio
- **Enviados automaticamente** - Navegador envia cookies com cada requisiÃ§Ã£o para o domÃ­nio
- **Podem expirar** - Defina datas de expiraÃ§Ã£o ou tempo de vida apenas da sessÃ£o
- **Escopo de domÃ­nio** - Apenas enviados para o domÃ­nio que os definiu
- **Escopo de caminho** - Podem ser limitados a caminhos de URL especÃ­ficos

**Casos de Uso Comuns:**
- ðŸ” **AutenticaÃ§Ã£o** - Armazenar IDs de sessÃ£o ou tokens
- ðŸŽ¨ **PreferÃªncias** - Lembrar configuraÃ§Ãµes do usuÃ¡rio (tema, idioma)
- ðŸ›’ **Carrinhos de Compras** - Rastrear itens antes do checkout
- ðŸ“Š **Analytics** - Rastrear comportamento do usuÃ¡rio
- ðŸŽ¯ **Marketing** - Mostrar conteÃºdo segmentado

## SeguranÃ§a de Cookies Explicada ðŸ”’

### Aprofundamento nas Flags de SeguranÃ§a

#### Flag httpOnly

**PropÃ³sito**: Prevenir acesso JavaScript aos cookies

```typescript
jar.set('session_id', 'abc123', {
  httpOnly: true  // âœ… JavaScript NÃƒO PODE acessar
});

// No console do navegador:
document.cookie;  // NÃ£o mostrarÃ¡ cookies httpOnly
```

**Por que importa**: Protege contra ataques XSS (Cross-Site Scripting). Mesmo se um atacante injetar JavaScript malicioso, ele nÃ£o pode roubar cookies httpOnly.

**Quando usar**:
- âœ… **Sempre** para tokens de autenticaÃ§Ã£o
- âœ… **Sempre** para IDs de sessÃ£o
- âŒ Nunca para dados que JavaScript precisa (como preferÃªncias de tema)

#### Flag secure

**PropÃ³sito**: Enviar cookies apenas via HTTPS

```typescript
jar.set('session_id', 'abc123', {
  secure: true  // Apenas enviado via HTTPS
});
```

**Por que importa**: Previne ataques man-in-the-middle. Cookies enviados via HTTP podem ser interceptados.

**Quando usar**:
- âœ… **Sempre** em produÃ§Ã£o
- âœ… Para qualquer dado sensÃ­vel
- âš ï¸ Defina como `false` apenas em desenvolvimento (localhost)

```typescript
const cookieOptions = {
  secure: process.env.NODE_ENV === 'production'  // Auto-detecta ambiente
};
```

#### Flag sameSite

**PropÃ³sito**: Controlar quando cookies sÃ£o enviados em requisiÃ§Ãµes cross-site

```typescript
// TrÃªs opÃ§Ãµes:

// 1. Strict - MÃ¡xima proteÃ§Ã£o
jar.set('session_id', 'abc123', {
  sameSite: 'strict'  // Nunca enviado em requisiÃ§Ãµes cross-site
});

// 2. Lax - Balanceado (padrÃ£o)
jar.set('session_id', 'abc123', {
  sameSite: 'lax'  // Enviado apenas em navegaÃ§Ã£o de nÃ­vel superior
});

// 3. None - Menor proteÃ§Ã£o
jar.set('tracking_id', 'xyz789', {
  sameSite: 'none',
  secure: true  // ObrigatÃ³rio quando sameSite=none
});
```

**Tabela de ComparaÃ§Ã£o:**

| sameSite | Clique em Link | POST de Form | AJAX/Fetch | iframe |
|----------|---------------|--------------|------------|---------|
| `strict` | âŒ NÃ£o enviado | âŒ NÃ£o enviado | âŒ NÃ£o enviado | âŒ NÃ£o enviado |
| `lax` | âœ… Enviado | âŒ NÃ£o enviado | âŒ NÃ£o enviado | âŒ NÃ£o enviado |
| `none` | âœ… Enviado | âœ… Enviado | âœ… Enviado | âœ… Enviado |

**Quando usar**:
- âœ… `strict` - Cookies de autenticaÃ§Ã£o para mÃ¡xima seguranÃ§a
- âœ… `lax` - Cookies de sessÃ£o que precisam funcionar com links externos
- âœ… `none` - IntegraÃ§Ãµes de terceiros, embeds (requer `secure: true`)

**Exemplo de Ataque Prevenido por sameSite:**

```
Sem sameSite:
1. UsuÃ¡rio faz login em banco.com (recebe cookie de sessÃ£o)
2. UsuÃ¡rio visita evil.com
3. evil.com faz POST para banco.com/transfer
4. Navegador envia cookie do banco.com â†’ Dinheiro transferido! ðŸ’¸

Com sameSite=strict:
3. evil.com faz POST para banco.com/transfer
4. Navegador BLOQUEIA cookie â†’ TransferÃªncia falha! âœ…
```

### Exemplo de SeguranÃ§a Completa

```typescript
const jar = new CookieJar('sua-chave-secreta');

// MÃ¡xima seguranÃ§a para autenticaÃ§Ã£o
app.post('/auth/login', (req, res) => {
  const user = authenticateUser(req.body);
  
  const cookie = jar.set('session_id', user.sessionId, {
    httpOnly: true,      // âœ… Sem acesso JavaScript
    secure: true,        // âœ… Apenas HTTPS
    sameSite: 'strict',  // âœ… Sem requisiÃ§Ãµes cross-site
    signed: true,        // âœ… Ã€ prova de adulteraÃ§Ã£o
    maxAge: 3600,        // âœ… Tempo de vida limitado (1 hora)
    path: '/'            // âœ… DisponÃ­vel em todo o site
  });
  
  res.setHeader('Set-Cookie', cookie);
  res.json({ message: 'Login seguro realizado' });
});
```

## Leitura e Escrita de Cookies ðŸ“–

### OperaÃ§Ãµes BÃ¡sicas

```typescript
import { CookieJar } from 'azurajs/cookies';

const jar = new CookieJar();

// Definir um cookie
app.get('/set-cookie', (req, res) => {
  const cookie = jar.set('username', 'john_doe', {
    maxAge: 86400, // 24 horas
    httpOnly: true,
    secure: true,
    sameSite: 'lax'
  });
  
  res.setHeader('Set-Cookie', cookie);
  res.json({ message: 'Cookie definido!' });
});

// Obter um cookie
app.get('/get-cookie', (req, res) => {
  const username = jar.get('username');
  
  if (!username) {
    return res.status(404).json({ error: 'Cookie nÃ£o encontrado' });
  }
  
  res.json({ username });
});

// Deletar um cookie
app.get('/delete-cookie', (req, res) => {
  const cookie = jar.delete('username');
  res.setHeader('Set-Cookie', cookie);
  res.json({ message: 'Cookie deletado' });
});

// Verificar se cookie existe
app.get('/has-cookie', (req, res) => {
  const exists = jar.has('username');
  res.json({ exists });
});

// Obter todos os cookies
app.get('/all-cookies', (req, res) => {
  const cookies = jar.all();
  res.json({ cookies });
});
```

### MÃºltiplos Cookies

```typescript
app.post('/login', (req, res) => {
  const user = authenticateUser(req.body);
  
  // Definir mÃºltiplos cookies
  const cookies = [
    jar.set('session_id', user.sessionId, {
      httpOnly: true,
      secure: true,
      maxAge: 3600
    }),
    jar.set('user_id', user.id, {
      httpOnly: true,
      secure: true,
      maxAge: 3600
    }),
    jar.set('theme', user.preferences.theme, {
      maxAge: 31536000  // 1 ano
    })
  ];
  
  res.setHeader('Set-Cookie', cookies);
  res.json({ user });
});
```

## Tabela Completa de OpÃ§Ãµes de Cookie ðŸ“‹

```typescript
interface CookieOptions {
  domain?: string;           // DomÃ­nio do cookie
  encode?: (value: string) => string;  // Codificador customizado
  expires?: Date;            // Data de expiraÃ§Ã£o
  httpOnly?: boolean;        // Flag HTTP only
  maxAge?: number;           // Idade mÃ¡xima em segundos
  path?: string;             // Caminho do cookie
  sameSite?: 'strict' | 'lax' | 'none';  // PolÃ­tica SameSite
  secure?: boolean;          // Flag secure (apenas HTTPS)
  signed?: boolean;          // Assinar cookie
  encrypted?: boolean;       // Criptografar cookie
  priority?: 'low' | 'medium' | 'high';  // Prioridade (Chrome)
}
```

### Detalhes das OpÃ§Ãµes

| OpÃ§Ã£o | Tipo | PadrÃ£o | DescriÃ§Ã£o | Exemplo |
|--------|------|---------|-------------|---------|
| `domain` | string | domÃ­nio atual | Escopo do domÃ­nio do cookie | `.example.com` |
| `expires` | Date | - | Data de expiraÃ§Ã£o absoluta | `new Date('2025-12-31')` |
| `httpOnly` | boolean | `false` | Prevenir acesso JavaScript | `true` |
| `maxAge` | number | - | Tempo de vida em segundos (relativo) | `3600` (1 hora) |
| `path` | string | `/` | Escopo do caminho da URL | `/admin` |
| `sameSite` | string | `lax` | PolÃ­tica de requisiÃ§Ã£o cross-site | `strict` |
| `secure` | boolean | `false` | Apenas HTTPS | `true` |
| `signed` | boolean | `false` | Adicionar assinatura para detectar adulteraÃ§Ã£o | `true` |
| `encrypted` | boolean | `false` | Criptografar valor do cookie | `true` |
| `priority` | string | - | Prioridade do navegador (apenas Chrome) | `high` |

### Exemplos de OpÃ§Ãµes

```typescript
// Escopo de domÃ­nio
jar.set('data', 'value', {
  domain: '.example.com'  // DisponÃ­vel em *.example.com
});

// Escopo de caminho
jar.set('admin_token', 'secret', {
  path: '/admin'  // Apenas enviado para rotas /admin/*
});

// ExpiraÃ§Ã£o (absoluta)
jar.set('promo', 'code123', {
  expires: new Date('2025-12-31')  // Expira em data especÃ­fica
});

// Idade mÃ¡xima (relativa)
jar.set('session', 'abc', {
  maxAge: 3600  // Expira em 1 hora a partir de agora
});

// Codificador customizado
jar.set('data', 'caracteres especiais!', {
  encode: (value) => Buffer.from(value).toString('base64')
});

// Prioridade (Chrome)
jar.set('critical_data', 'value', {
  priority: 'high'  // Manter este cookie quando o armazenamento estiver cheio
});
```

## Cookies Assinados ðŸ”

**PropÃ³sito**: Detectar adulteraÃ§Ã£o de cookies

### Como a Assinatura Funciona

```
1. Servidor cria valor do cookie: "user_id=123"
2. Servidor gera assinatura: HMAC-SHA256(value, secret)
3. Servidor envia: "user_id=123.assinatura"
4. Cliente armazena: "user_id=123.assinatura"
5. Cliente envia de volta: "user_id=123.assinatura"
6. Servidor verifica: assinatura corresponde? âœ… VÃ¡lido : âŒ Adulterado
```

### ImplementaÃ§Ã£o

```typescript
const jar = new CookieJar('minha-chave-secreta-mude-em-producao');

// Definir cookie assinado
app.post('/auth/login', (req, res) => {
  const user = authenticateUser(req.body);
  
  const cookie = jar.set('user_id', user.id, {
    signed: true,       // Habilitar assinatura
    httpOnly: true,
    secure: true,
    sameSite: 'strict',
    maxAge: 86400
  });
  
  res.setHeader('Set-Cookie', cookie);
  res.json({ message: 'Login realizado' });
});

// Verificar cookie assinado
app.get('/auth/me', (req, res) => {
  const userId = jar.get('user_id', true);  // true = verificar assinatura
  
  if (!userId) {
    return res.status(401).json({ 
      error: 'Cookie invÃ¡lido ou adulterado' 
    });
  }
  
  const user = getUserById(userId);
  res.json({ user });
});
```

### Quando Usar Cookies Assinados

âœ… **Use cookies assinados quando**:
- Armazenar IDs de usuÃ¡rio
- Armazenar dados de role/permissÃµes
- Armazenar qualquer dado usado para autorizaÃ§Ã£o
- Dados que afetam a seguranÃ§a se adulterados

âŒ **NÃ£o use cookies assinados para**:
- Dados pÃºblicos (tema, idioma)
- Dados que nÃ£o afetam a seguranÃ§a
- Cookies criptografados (jÃ¡ sÃ£o seguros)

## Fluxo de AutenticaÃ§Ã£o Baseado em Cookies ðŸ”

### Exemplo Completo Passo a Passo

```typescript
import { CookieJar, SessionManager, MemorySessionStore } from 'azurajs/cookies';
import { randomUUID } from 'crypto';

// Passo 1: ConfiguraÃ§Ã£o
const jar = new CookieJar('sua-chave-secreta');
const sessionManager = new SessionManager(new MemorySessionStore(), {
  cookieName: 'azura.sid',
  secret: 'chave-secreta-sessao',
  cookieOptions: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 86400  // 24 horas
  }
});

// Passo 2: Login - Criar SessÃ£o
app.post('/auth/login', async (req, res) => {
  const { email, password } = req.body;
  
  // Validar credenciais
  const user = await validateCredentials(email, password);
  if (!user) {
    return res.status(401).json({ error: 'Credenciais invÃ¡lidas' });
  }
  
  // Criar sessÃ£o
  const { id, cookie } = await sessionManager.create({
    userId: user.id,
    email: user.email,
    role: user.role,
    loginAt: new Date().toISOString(),
    ip: req.ip
  });
  
  // Definir cookie de sessÃ£o
  res.setHeader('Set-Cookie', cookie);
  
  // Retornar dados do usuÃ¡rio (nÃ£o incluir senha!)
  res.json({
    user: {
      id: user.id,
      email: user.email,
      name: user.name,
      role: user.role
    },
    sessionId: id
  });
});

// Passo 3: Middleware de AutenticaÃ§Ã£o
async function authenticateUser(req, res, next) {
  const session = await sessionManager.get(req.cookies);
  
  if (!session) {
    return res.status(401).json({ error: 'NÃ£o autenticado' });
  }
  
  // Anexar dados da sessÃ£o Ã  requisiÃ§Ã£o
  req.session = session.data;
  req.sessionId = session.id;
  
  // Atualizar Ãºltima atividade
  await sessionManager.touch(session.id);
  
  next();
}

// Passo 4: Rotas Protegidas
app.get('/api/dashboard', authenticateUser, (req, res) => {
  res.json({
    message: 'Bem-vindo ao seu painel',
    user: {
      email: req.session.email,
      role: req.session.role,
      loginAt: req.session.loginAt
    }
  });
});

// AutorizaÃ§Ã£o baseada em role
function requireRole(role) {
  return (req, res, next) => {
    if (req.session.role !== role) {
      return res.status(403).json({ error: 'PermissÃµes insuficientes' });
    }
    next();
  };
}

app.get('/api/admin', authenticateUser, requireRole('admin'), (req, res) => {
  res.json({ message: 'Ãrea administrativa' });
});

// Passo 5: Logout - Destruir SessÃ£o
app.post('/auth/logout', async (req, res) => {
  if (req.sessionId) {
    const cookie = await sessionManager.destroy(req.sessionId);
    res.setHeader('Set-Cookie', cookie);
  }
  
  res.json({ message: 'Logout realizado com sucesso' });
});

// Passo 6: Atualizar SessÃ£o
app.post('/auth/refresh', authenticateUser, async (req, res) => {
  // Atualizar dados da sessÃ£o
  await sessionManager.update(req.sessionId, {
    ...req.session,
    lastRefresh: new Date().toISOString()
  });
  
  res.json({ message: 'SessÃ£o atualizada' });
});

// Passo 7: Obter UsuÃ¡rio Atual
app.get('/auth/me', authenticateUser, (req, res) => {
  res.json({
    user: {
      userId: req.session.userId,
      email: req.session.email,
      role: req.session.role
    }
  });
});
```

### Diagrama do Fluxo de AutenticaÃ§Ã£o

```
1. RequisiÃ§Ã£o de Login
   POST /auth/login
   { email, password }
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Validar UsuÃ¡rio â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ VÃ¡lido
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Criar SessÃ£o    â”‚
   â”‚ Armazenar no DB â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Definir Cookie  â”‚
   â”‚  Resposta       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   Navegador armazena cookie
   
2. RequisiÃ§Ã£o Autenticada
   GET /api/dashboard
   Cookie: azura.sid=abc123
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Ler Cookie     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Carregar SessÃ£o â”‚
   â”‚  do DB          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ VÃ¡lido
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Processar Req   â”‚
   â”‚ Enviar Resposta â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. RequisiÃ§Ã£o de Logout
   POST /auth/logout
   Cookie: azura.sid=abc123
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Deletar SessÃ£o  â”‚
   â”‚  do DB          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Limpar Cookie   â”‚
   â”‚  Resposta       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Gerenciamento de SessÃµes ðŸ’¼

### Uso BÃ¡sico de SessÃ£o

```typescript
import { SessionManager, MemorySessionStore } from 'azurajs/cookies';

const sessionManager = new SessionManager(new MemorySessionStore(), {
  cookieName: 'azura.sid',
  secret: 'chave-secreta-sessao',
  cookieOptions: {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 86400  // 24 horas
  }
});

// Middleware de carregamento de sessÃ£o
app.use(async (req, res, next) => {
  const session = await sessionManager.get(req.cookies);
  
  if (session) {
    req.session = session.data;
    req.sessionId = session.id;
  }
  
  next();
});
```

### Armazenamento de SessÃ£o Customizado (Redis)

```typescript
import { SessionStore } from 'azurajs/cookies';
import Redis from 'ioredis';

class RedisSessionStore implements SessionStore {
  private redis: Redis;
  
  constructor(redisClient: Redis) {
    this.redis = redisClient;
  }
  
  async get(id: string): Promise<any | undefined> {
    const data = await this.redis.get(`session:${id}`);
    return data ? JSON.parse(data) : undefined;
  }
  
  async set(id: string, data: any, maxAge: number): Promise<void> {
    await this.redis.set(
      `session:${id}`,
      JSON.stringify(data),
      'PX',  // milissegundos
      maxAge * 1000
    );
  }
  
  async destroy(id: string): Promise<void> {
    await this.redis.del(`session:${id}`);
  }
  
  async touch(id: string, maxAge: number): Promise<void> {
    await this.redis.expire(`session:${id}`, maxAge);
  }
}

// Usar armazenamento customizado
const redisClient = new Redis();
const sessionManager = new SessionManager(
  new RedisSessionStore(redisClient),
  {
    cookieName: 'sid',
    secret: 'secret',
    cookieOptions: { httpOnly: true, secure: true }
  }
);
```

### Armazenamento de SessÃ£o Customizado (MongoDB)

```typescript
import { SessionStore } from 'azurajs/cookies';
import { MongoClient, Collection } from 'mongodb';

interface SessionDocument {
  _id: string;
  data: any;
  expiresAt: Date;
}

class MongoSessionStore implements SessionStore {
  private collection: Collection<SessionDocument>;
  
  constructor(collection: Collection<SessionDocument>) {
    this.collection = collection;
    
    // Criar Ã­ndice TTL para limpeza automÃ¡tica
    this.collection.createIndex({ expiresAt: 1 }, { expireAfterSeconds: 0 });
  }
  
  async get(id: string): Promise<any | undefined> {
    const doc = await this.collection.findOne({ _id: id });
    
    if (!doc) return undefined;
    if (doc.expiresAt < new Date()) {
      await this.destroy(id);
      return undefined;
    }
    
    return doc.data;
  }
  
  async set(id: string, data: any, maxAge: number): Promise<void> {
    const expiresAt = new Date(Date.now() + maxAge * 1000);
    
    await this.collection.updateOne(
      { _id: id },
      {
        $set: {
          data,
          expiresAt
        }
      },
      { upsert: true }
    );
  }
  
  async destroy(id: string): Promise<void> {
    await this.collection.deleteOne({ _id: id });
  }
  
  async touch(id: string, maxAge: number): Promise<void> {
    const expiresAt = new Date(Date.now() + maxAge * 1000);
    await this.collection.updateOne(
      { _id: id },
      { $set: { expiresAt } }
    );
  }
}

// ConfiguraÃ§Ã£o
const client = new MongoClient('mongodb://localhost:27017');
await client.connect();
const db = client.db('myapp');
const sessions = db.collection<SessionDocument>('sessions');

const sessionManager = new SessionManager(
  new MongoSessionStore(sessions),
  {
    cookieName: 'sid',
    secret: 'secret',
    cookieOptions: { httpOnly: true, secure: true }
  }
);
```

## Melhores PrÃ¡ticas de SeguranÃ§a ðŸ’Ž

### 10+ PrÃ¡ticas Essenciais de SeguranÃ§a

#### 1. Sempre Use httpOnly para Cookies de AutenticaÃ§Ã£o

```typescript
// âŒ Ruim - JavaScript pode acessar
jar.set('session_id', id, {
  httpOnly: false
});

// âœ… Bom - Protegido de XSS
jar.set('session_id', id, {
  httpOnly: true
});
```

#### 2. Habilite secure em ProduÃ§Ã£o

```typescript
// âœ… Bom - Consciente do ambiente
const cookieOptions = {
  secure: process.env.NODE_ENV === 'production',
  httpOnly: true,
  sameSite: 'strict'
};
```

#### 3. Use sameSite para ProteÃ§Ã£o CSRF

```typescript
// âœ… Bom - MÃ¡xima proteÃ§Ã£o CSRF
jar.set('session_id', id, {
  sameSite: 'strict',  // ou 'lax' se necessÃ¡rio
  httpOnly: true,
  secure: true
});
```

#### 4. Defina ExpiraÃ§Ã£o Apropriada

```typescript
// âŒ Ruim - Nunca expira
jar.set('session_id', id, {});

// âœ… Bom - Tempo de vida limitado
jar.set('session_id', id, {
  maxAge: 3600  // 1 hora
});

// âœ… Bom - Mais longo para "lembrar-me"
jar.set('remember_token', token, {
  maxAge: 30 * 24 * 3600  // 30 dias
});
```

#### 5. Assine Cookies SensÃ­veis

```typescript
// âœ… Bom - Detectar adulteraÃ§Ã£o
jar.set('user_role', 'admin', {
  signed: true,
  httpOnly: true,
  secure: true
});
```

#### 6. Criptografe PII (InformaÃ§Ãµes Pessoais IdentificÃ¡veis)

```typescript
// âœ… Bom - Criptografar dados sensÃ­veis
jar.set('user_cpf', cpf, {
  encrypted: true,
  httpOnly: true,
  secure: true,
  signed: true
});
```

#### 7. Use AleatÃ³rio Seguro para IDs de SessÃ£o

```typescript
import { randomBytes } from 'crypto';

// âœ… Bom - Criptograficamente seguro
const sessionId = randomBytes(32).toString('hex');

// âŒ Ruim - PrevisÃ­vel
const sessionId = Date.now().toString();
```

#### 8. Implemente RotaÃ§Ã£o de SessÃ£o

```typescript
// Rotacionar ID de sessÃ£o em elevaÃ§Ã£o de privilÃ©gio
app.post('/upgrade-to-premium', authenticateUser, async (req, res) => {
  // Destruir sessÃ£o antiga
  await sessionManager.destroy(req.sessionId);
  
  // Criar nova sessÃ£o com role atualizado
  const { id, cookie } = await sessionManager.create({
    ...req.session,
    role: 'premium',
    upgradedAt: new Date()
  });
  
  res.setHeader('Set-Cookie', cookie);
  res.json({ message: 'Upgrade realizado!' });
});
```

#### 9. Valide Valores de Cookies

```typescript
import { v } from 'azurajs/validators';

const SessionSchema = v.object({
  userId: v.string().uuid(),
  role: v.enum(['user', 'admin', 'premium']),
  expiresAt: v.number()
});

app.use(async (req, res, next) => {
  const session = await sessionManager.get(req.cookies);
  
  if (session) {
    const result = SessionSchema.safeParse(session.data);
    
    if (!result.success) {
      // Dados de sessÃ£o invÃ¡lidos - destruir
      await sessionManager.destroy(session.id);
      return res.status(401).json({ error: 'SessÃ£o invÃ¡lida' });
    }
    
    req.session = result.data;
  }
  
  next();
});
```

#### 10. Implemente LimitaÃ§Ã£o de Taxa

```typescript
const loginAttempts = new Map<string, number>();

app.post('/auth/login', (req, res) => {
  const ip = req.ip;
  const attempts = loginAttempts.get(ip) || 0;
  
  if (attempts >= 5) {
    return res.status(429).json({ 
      error: 'Muitas tentativas de login. Tente novamente em 15 minutos.' 
    });
  }
  
  const user = authenticateUser(req.body);
  
  if (!user) {
    loginAttempts.set(ip, attempts + 1);
    setTimeout(() => loginAttempts.delete(ip), 15 * 60 * 1000);
    return res.status(401).json({ error: 'Credenciais invÃ¡lidas' });
  }
  
  // Sucesso - resetar tentativas
  loginAttempts.delete(ip);
  
  // ... criar sessÃ£o
});
```

#### 11. Registre Eventos de SeguranÃ§a

```typescript
import { createLogger } from 'winston';

const securityLogger = createLogger({
  // ... config
});

app.post('/auth/login', async (req, res) => {
  const result = await attemptLogin(req.body);
  
  securityLogger.info('Tentativa de login', {
    success: result.success,
    email: req.body.email,
    ip: req.ip,
    userAgent: req.headers['user-agent'],
    timestamp: new Date()
  });
  
  // ... resto da lÃ³gica de login
});
```

#### 12. Limpe SessÃµes Expiradas

```typescript
// Executar tarefa de limpeza periodicamente
setInterval(async () => {
  const now = Date.now();
  const sessions = await getAllSessions();
  
  for (const session of sessions) {
    if (session.expiresAt < now) {
      await sessionManager.destroy(session.id);
    }
  }
}, 60 * 60 * 1000);  // A cada hora
```

## ConsideraÃ§Ãµes sobre GDPR ðŸ‡ªðŸ‡º

### Consentimento de Cookies

```typescript
app.get('/', (req, res) => {
  const consent = jar.get('cookie_consent');
  
  if (!consent) {
    // Mostrar banner de cookies
    return res.send(`
      <div class="cookie-banner">
        <p>Usamos cookies para melhorar sua experiÃªncia.</p>
        <button onclick="acceptCookies()">Aceitar Todos</button>
        <button onclick="rejectCookies()">Rejeitar NÃ£o Essenciais</button>
      </div>
    `);
  }
  
  // UsuÃ¡rio consentiu
  if (consent === 'accepted') {
    // Definir cookies de analytics
    jar.set('analytics_id', generateId(), { maxAge: 31536000 });
  }
  
  res.send('Bem-vindo!');
});

app.post('/api/cookie-consent', (req, res) => {
  const { consent } = req.body;  // 'accepted' ou 'rejected'
  
  const cookie = jar.set('cookie_consent', consent, {
    maxAge: 365 * 24 * 3600  // 1 ano
  });
  
  res.setHeader('Set-Cookie', cookie);
  res.json({ message: 'Consentimento registrado' });
});
```

### PÃ¡gina de PolÃ­tica de Cookies

```typescript
app.get('/cookie-policy', (req, res) => {
  res.json({
    essential: [
      {
        name: 'session_id',
        purpose: 'AutenticaÃ§Ã£o de usuÃ¡rio',
        duration: '24 horas',
        type: 'essencial'
      }
    ],
    analytics: [
      {
        name: 'analytics_id',
        purpose: 'Analytics de uso',
        duration: '1 ano',
        type: 'analytics',
        provider: 'Google Analytics'
      }
    ]
  });
});
```

### Direito de Ser Esquecido

```typescript
app.delete('/api/user/data', authenticateUser, async (req, res) => {
  const userId = req.session.userId;
  
  // Deletar dados do usuÃ¡rio
  await deleteUserData(userId);
  
  // Deletar sessÃ£o
  await sessionManager.destroy(req.sessionId);
  
  // Limpar todos os cookies
  const cookies = [
    jar.delete('session_id'),
    jar.delete('analytics_id'),
    jar.delete('preferences')
  ];
  
  res.setHeader('Set-Cookie', cookies);
  res.json({ message: 'Todos os dados deletados' });
});
```

### Coleta MÃ­nima de Dados

```typescript
// âŒ Ruim - Coletando dados desnecessÃ¡rios
const session = {
  userId: user.id,
  email: user.email,
  phone: user.phone,
  address: user.address,
  creditCard: user.creditCard  // Nunca!
};

// âœ… Bom - Dados mÃ­nimos necessÃ¡rios
const session = {
  userId: user.id,
  role: user.role,
  expiresAt: Date.now() + 3600000
};
```

### Log de Auditoria de Cookies

```typescript
app.use((req, res, next) => {
  const originalSetHeader = res.setHeader;
  
  res.setHeader = function(name, value) {
    if (name.toLowerCase() === 'set-cookie') {
      // Registrar cookie sendo definido
      auditLogger.info('Cookie definido', {
        cookie: typeof value === 'string' ? parseCookieName(value) : value.map(parseCookieName),
        route: req.path,
        timestamp: new Date()
      });
    }
    
    return originalSetHeader.call(this, name, value);
  };
  
  next();
});

function parseCookieName(cookieString: string): string {
  return cookieString.split('=')[0];
}
```

## SoluÃ§Ã£o de Problemas ðŸ”§

### Problema: Cookies NÃ£o Sendo Definidos

**Sintomas**: Cookie nÃ£o aparece no navegador

**Causas e SoluÃ§Ãµes PossÃ­veis**:

```typescript
// 1. Verificar flag secure em desenvolvimento
// âŒ Problema
jar.set('token', 'value', {
  secure: true  // NÃ£o funcionarÃ¡ em localhost HTTP
});

// âœ… SoluÃ§Ã£o
jar.set('token', 'value', {
  secure: process.env.NODE_ENV === 'production'
});

// 2. Verificar sameSite=none requer secure
// âŒ Problema
jar.set('token', 'value', {
  sameSite: 'none'  // Deve ter secure: true
});

// âœ… SoluÃ§Ã£o
jar.set('token', 'value', {
  sameSite: 'none',
  secure: true
});

// 3. Verificar incompatibilidade de domÃ­nio
// âŒ Problema
jar.set('token', 'value', {
  domain: 'example.com'  // NÃ£o funcionarÃ¡ em localhost
});

// âœ… SoluÃ§Ã£o
jar.set('token', 'value', {
  domain: process.env.NODE_ENV === 'production' ? '.example.com' : undefined
});

// 4. Verificar navegador bloqueando cookies de terceiros
// SoluÃ§Ã£o: Use sameSite='lax' ou 'strict' para cookies primÃ¡rios
```

### Problema: Cookies NÃ£o Sendo Enviados

**Sintomas**: Cookie existe mas nÃ£o Ã© enviado com requisiÃ§Ãµes

**Causas e SoluÃ§Ãµes PossÃ­veis**:

```typescript
// 1. Incompatibilidade de caminho
// Cookie definido com path: '/admin'
// RequisiÃ§Ã£o para: '/api/users' â†’ Cookie nÃ£o enviado

// âœ… SoluÃ§Ã£o: Use path: '/' para cookies de todo o site
jar.set('token', 'value', {
  path: '/'
});

// 2. Incompatibilidade de domÃ­nio
// DomÃ­nio do cookie: 'api.example.com'
// RequisiÃ§Ã£o para: 'www.example.com' â†’ Cookie nÃ£o enviado

// âœ… SoluÃ§Ã£o: Use domÃ­nio pai
jar.set('token', 'value', {
  domain: '.example.com'  // Funciona para todos os subdomÃ­nios
});

// 3. Cookie expirado
// âœ… SoluÃ§Ã£o: Verificar expiraÃ§Ã£o
const cookie = jar.get('token');
if (!cookie) {
  console.log('Cookie expirado ou nÃ£o definido');
}
```

### Problema: Assinatura de Cookie InvÃ¡lida

**Sintomas**: `jar.get(name, true)` retorna `null`

**SoluÃ§Ã£o**:

```typescript
// Certifique-se de que a chave secreta seja consistente
const SECRET = process.env.COOKIE_SECRET;

// âŒ Ruim - Segredos diferentes
const jar1 = new CookieJar('secret1');
jar1.set('token', 'value', { signed: true });

const jar2 = new CookieJar('secret2');
jar2.get('token', true);  // Retorna null - assinaturas nÃ£o coincidem

// âœ… Bom - Mesmo segredo
const jar1 = new CookieJar(SECRET);
jar1.set('token', 'value', { signed: true });

const jar2 = new CookieJar(SECRET);
jar2.get('token', true);  // Funciona!
```

### Problema: SessÃ£o Perdida ao Atualizar

**Causas e SoluÃ§Ãµes**:

```typescript
// 1. SessÃ£o nÃ£o persistida
// âœ… SoluÃ§Ã£o: Use armazenamento persistente (Redis/MongoDB)
const sessionManager = new SessionManager(
  new RedisSessionStore(redis),  // NÃ£o MemorySessionStore
  { /* options */ }
);

// 2. Cookie expirado
// âœ… SoluÃ§Ã£o: Aumentar maxAge
cookieOptions: {
  maxAge: 86400  // 24 horas em vez de 3600 (1 hora)
}

// 3. Touch session na atividade
app.use(async (req, res, next) => {
  if (req.sessionId) {
    await sessionManager.touch(req.sessionId);  // Estender sessÃ£o
  }
  next();
});
```

## PadrÃµes Comuns ðŸŽ¨

### 1. Funcionalidade Lembrar-me

```typescript
app.post('/auth/login', async (req, res) => {
  const { email, password, rememberMe } = req.body;
  const user = await authenticateUser(email, password);
  
  if (!user) {
    return res.status(401).json({ error: 'Credenciais invÃ¡lidas' });
  }
  
  // SessÃ£o de curta duraÃ§Ã£o
  const sessionCookie = jar.set('session_id', user.sessionId, {
    httpOnly: true,
    secure: true,
    sameSite: 'strict',
    maxAge: 3600  // 1 hora
  });
  
  const cookies = [sessionCookie];
  
  // Token de lembrar-me de longa duraÃ§Ã£o (se solicitado)
  if (rememberMe) {
    const rememberToken = generateSecureToken();
    await storeRememberToken(user.id, rememberToken);
    
    const rememberCookie = jar.set('remember_token', rememberToken, {
      httpOnly: true,
      secure: true,
      sameSite: 'strict',
      signed: true,
      maxAge: 30 * 24 * 3600  // 30 dias
    });
    
    cookies.push(rememberCookie);
  }
  
  res.setHeader('Set-Cookie', cookies);
  res.json({ user });
});

// Middleware lembrar-me
app.use(async (req, res, next) => {
  // Verificar sessÃ£o primeiro
  if (req.session) {
    return next();
  }
  
  // Tentar token de lembrar-me
  const rememberToken = jar.get('remember_token', true);
  if (rememberToken) {
    const userId = await validateRememberToken(rememberToken);
    
    if (userId) {
      // Criar nova sessÃ£o
      const user = await getUserById(userId);
      const { id, cookie } = await sessionManager.create({
        userId: user.id,
        email: user.email,
        role: user.role,
        rememberedLogin: true
      });
      
      res.setHeader('Set-Cookie', cookie);
      req.session = { userId, email: user.email, role: user.role };
    }
  }
  
  next();
});
```

### 2. Armazenamento de Tema/PreferÃªncias

```typescript
app.post('/api/preferences', (req, res) => {
  const { theme, language, timezone, fontSize } = req.body;
  
  const cookies = [
    jar.set('pref_theme', theme, {
      maxAge: 365 * 24 * 3600,  // 1 ano
      sameSite: 'lax'
    }),
    jar.set('pref_language', language, {
      maxAge: 365 * 24 * 3600,
      sameSite: 'lax'
    }),
    jar.set('pref_timezone', timezone, {
      maxAge: 365 * 24 * 3600,
      sameSite: 'lax'
    }),
    jar.set('pref_fontSize', fontSize, {
      maxAge: 365 * 24 * 3600,
      sameSite: 'lax'
    })
  ];
  
  res.setHeader('Set-Cookie', cookies);
  res.json({ message: 'PreferÃªncias salvas' });
});

// Middleware de aplicaÃ§Ã£o de preferÃªncias
app.use((req, res, next) => {
  req.preferences = {
    theme: jar.get('pref_theme') || 'light',
    language: jar.get('pref_language') || 'pt',
    timezone: jar.get('pref_timezone') || 'America/Sao_Paulo',
    fontSize: jar.get('pref_fontSize') || 'medium'
  };
  next();
});
```

### 3. Carrinho de Compras

```typescript
interface CartItem {
  productId: string;
  quantity: number;
  price: number;
}

app.post('/api/cart/add', (req, res) => {
  const { productId, quantity } = req.body;
  
  // Obter carrinho existente
  const cartCookie = jar.get('cart');
  const cart: CartItem[] = cartCookie ? JSON.parse(cartCookie) : [];
  
  // Adicionar ou atualizar item
  const existingItem = cart.find(item => item.productId === productId);
  if (existingItem) {
    existingItem.quantity += quantity;
  } else {
    const product = getProduct(productId);
    cart.push({
      productId,
      quantity,
      price: product.price
    });
  }
  
  // Salvar carrinho
  const cookie = jar.set('cart', JSON.stringify(cart), {
    maxAge: 7 * 24 * 3600,  // 7 dias
    sameSite: 'lax'
  });
  
  res.setHeader('Set-Cookie', cookie);
  res.json({ cart, total: calculateTotal(cart) });
});

app.get('/api/cart', (req, res) => {
  const cartCookie = jar.get('cart');
  const cart: CartItem[] = cartCookie ? JSON.parse(cartCookie) : [];
  
  res.json({
    cart,
    total: calculateTotal(cart),
    itemCount: cart.reduce((sum, item) => sum + item.quantity, 0)
  });
});

app.delete('/api/cart', (req, res) => {
  const cookie = jar.delete('cart');
  res.setHeader('Set-Cookie', cookie);
  res.json({ message: 'Carrinho limpo' });
});
```

### 4. Mensagens Flash

```typescript
app.use((req, res, next) => {
  // Obter mensagem flash
  const flashCookie = jar.get('_flash');
  if (flashCookie) {
    req.flash = JSON.parse(decodeURIComponent(flashCookie));
    
    // Limpar cookie flash
    const clearCookie = jar.delete('_flash');
    res.setHeader('Set-Cookie', clearCookie);
  }
  
  // Helper para definir flash
  res.flash = function(type: string, message: string) {
    const flashData = JSON.stringify({ type, message });
    const cookie = jar.set('_flash', encodeURIComponent(flashData), {
      httpOnly: true,
      sameSite: 'lax'
      // Sem maxAge - apenas sessÃ£o
    });
    this.setHeader('Set-Cookie', cookie);
    return this;
  };
  
  next();
});

// Uso
app.post('/api/save', (req, res) => {
  saveData(req.body);
  res.flash('success', 'Dados salvos com sucesso!');
  res.redirect('/dashboard');
});

app.get('/dashboard', (req, res) => {
  res.json({
    flash: req.flash || null,  // { type: 'success', message: 'Dados salvos com sucesso!' }
    data: getDashboardData()
  });
});
```

### 5. Gerenciamento de Token CSRF

```typescript
import { randomBytes } from 'crypto';

const csrfTokens = new Map<string, { token: string; expiresAt: number }>();

// Gerar middleware de token CSRF
app.use((req, res, next) => {
  let csrfToken = jar.get('csrf_token');
  
  if (!csrfToken || !csrfTokens.has(csrfToken)) {
    csrfToken = randomBytes(32).toString('hex');
    csrfTokens.set(csrfToken, {
      token: csrfToken,
      expiresAt: Date.now() + 3600000  // 1 hora
    });
    
    const cookie = jar.set('csrf_token', csrfToken, {
      httpOnly: false,  // Precisa ser acessÃ­vel ao JavaScript
      secure: true,
      sameSite: 'strict',
      maxAge: 3600
    });
    
    res.setHeader('Set-Cookie', cookie);
  }
  
  req.csrfToken = csrfToken;
  next();
});

// Verificar token CSRF
function verifyCsrfToken(req, res, next) {
  const tokenFromRequest = req.header('x-csrf-token') || req.body._csrf;
  const tokenFromCookie = jar.get('csrf_token');
  
  if (!tokenFromRequest || !tokenFromCookie || tokenFromRequest !== tokenFromCookie) {
    return res.status(403).json({ error: 'Token CSRF invÃ¡lido' });
  }
  
  const tokenData = csrfTokens.get(tokenFromCookie);
  if (!tokenData || tokenData.expiresAt < Date.now()) {
    csrfTokens.delete(tokenFromCookie);
    return res.status(403).json({ error: 'Token CSRF expirado' });
  }
  
  next();
}

// Usar em rotas que mudam estado
app.post('/api/transfer', verifyCsrfToken, (req, res) => {
  // Seguro contra ataques CSRF
  performTransfer(req.body);
  res.json({ success: true });
});

// Limpar tokens expirados
setInterval(() => {
  const now = Date.now();
  for (const [token, data] of csrfTokens.entries()) {
    if (data.expiresAt < now) {
      csrfTokens.delete(token);
    }
  }
}, 60000);  // A cada minuto
```

## ReferÃªncia Completa da API ðŸ“–

### CookieJar

```typescript
class CookieJar {
  constructor(secret?: string);
  
  set(name: string, value: string, options?: CookieOptions): string;
  get(name: string, signed?: boolean, encrypted?: boolean): string | undefined;
  delete(name: string, options?: Partial<CookieOptions>): string;
  has(name: string): boolean;
  all(): Record<string, string>;
  clear(): void;
}
```

### SessionManager

```typescript
class SessionManager {
  constructor(store: SessionStore, options: SessionOptions);
  
  get(cookies: Record<string, string>): Promise<Session | undefined>;
  create(data: any): Promise<{ id: string; cookie: string }>;
  update(id: string, data: any): Promise<void>;
  destroy(id: string): Promise<string>;
  touch(id: string): Promise<void>;
}

interface SessionStore {
  get(id: string): Promise<any | undefined>;
  set(id: string, data: any, maxAge: number): Promise<void>;
  destroy(id: string): Promise<void>;
  touch(id: string, maxAge: number): Promise<void>;
}

interface SessionOptions {
  cookieName: string;
  secret: string;
  cookieOptions: CookieOptions;
}
```

### CookiePresets

```typescript
class CookiePresets {
  static session(secure?: boolean): CookieOptions;      // 24 horas
  static rememberMe(secure?: boolean): CookieOptions;   // 30 dias
  static tracking(secure?: boolean): CookieOptions;     // 1 ano
  static flash(secure?: boolean): CookieOptions;        // Apenas sessÃ£o
  static csrf(secure?: boolean): CookieOptions;         // 1 hora
}
```

## Cookies Criptografados ðŸ”

Armazene dados sensÃ­veis de forma segura:

```typescript
const jar = new CookieJar('chave-secreta-criptografia');

// Criptografar dados sensÃ­veis
app.post('/secure/set', (req, res) => {
  const sensitiveData = JSON.stringify({
    cpf: '123.456.789-00',
    cartaoCredito: '1234-5678-9012-3456'
  });
  
  const cookie = jar.set('secure_data', sensitiveData, {
    encrypted: true,
    httpOnly: true,
    secure: true,
    sameSite: 'strict'
  });
  
  res.setHeader('Set-Cookie', cookie);
  res.json({ message: 'Dados seguros armazenados' });
});

// Descriptografar cookie
app.get('/secure/get', (req, res) => {
  const encryptedData = jar.get('secure_data', false, true); // true = descriptografar
  
  if (!encryptedData) {
    return res.status(404).json({ error: 'Nenhum dado encontrado' });
  }
  
  const data = JSON.parse(encryptedData);
  res.json(data);
});
```

## Gerenciamento de SessÃµes AvanÃ§ado ðŸ’¼

Gerenciamento de sessÃµes integrado com armazenamento baseado em cookies.

### SessÃµes BÃ¡sicas

```typescript
import { SessionManager, MemorySessionStore } from 'azurajs/cookies';

const sessionManager = new SessionManager(new MemorySessionStore(), {
  cookieName: 'azura.sid',
  secret: 'chave-secreta-sessao',
  cookieOptions: {
    httpOnly: true,
    secure: true,
    sameSite: 'lax',
    maxAge: 86400 // 24 horas
  }
});

// Middleware para carregar sessÃµes
app.use(async (req, res, next) => {
  const session = await sessionManager.get(req.cookies);
  
  if (session) {
    req.session = session.data;
    req.sessionId = session.id;
  }
  
  next();
});

// Criar sessÃ£o no login
app.post('/session/login', async (req, res) => {
  const { email, password } = req.body;
  
  // Validar credenciais...
  
  const { id, cookie } = await sessionManager.create({
    userId: '12345',
    email,
    loginAt: new Date()
  });
  
  res.setHeader('Set-Cookie', cookie);
  res.json({
    message: 'SessÃ£o criada',
    sessionId: id
  });
});

// Acessar dados da sessÃ£o
app.get('/session/data', (req, res) => {
  if (!req.session) {
    return res.status(401).json({ error: 'Nenhuma sessÃ£o ativa' });
  }
  
  res.json({ session: req.session });
});

// Destruir sessÃ£o
app.post('/session/logout', async (req, res) => {
  if (req.sessionId) {
    const cookie = await sessionManager.destroy(req.sessionId);
    res.setHeader('Set-Cookie', cookie);
  }
  
  res.json({ message: 'Logout realizado' });
});
```

### Armazenamento de SessÃ£o Customizado

Implemente seu prÃ³prio armazenamento de sessÃ£o (Redis, MongoDB, etc.):

```typescript
import { SessionStore } from 'azurajs/cookies';

class RedisSessionStore implements SessionStore {
  private redis: RedisClient;
  
  constructor(redisClient: RedisClient) {
    this.redis = redisClient;
  }
  
  async get(id: string): Promise<any | undefined> {
    const data = await this.redis.get(`session:${id}`);
    return data ? JSON.parse(data) : undefined;
  }
  
  async set(id: string, data: any, maxAge: number): Promise<void> {
    await this.redis.set(
      `session:${id}`,
      JSON.stringify(data),
      'PX',
      maxAge
    );
  }
  
  async destroy(id: string): Promise<void> {
    await this.redis.del(`session:${id}`);
  }
  
  async touch(id: string, maxAge: number): Promise<void> {
    await this.redis.expire(`session:${id}`, Math.floor(maxAge / 1000));
  }
}

// Usar armazenamento customizado
const sessionManager = new SessionManager(
  new RedisSessionStore(redisClient),
  { cookieName: 'sid', secret: 'secret' }
);
```

## Presets de Cookies ðŸŽ¨

OpÃ§Ãµes de cookies prÃ©-configuradas para casos de uso comuns:

```typescript
import { CookiePresets } from 'azurajs/cookies';

// Cookie de sessÃ£o (24 horas)
res.cookie('user', data, CookiePresets.session(true));

// Cookie lembrar-me (30 dias)
res.cookie('remember_token', token, CookiePresets.rememberMe(true));

// Cookie de rastreamento (1 ano)
res.cookie('tracking_id', id, CookiePresets.tracking());

// Mensagem flash (apenas sessÃ£o)
res.cookie('flash', message, CookiePresets.flash(true));

// Token CSRF
res.cookie('csrf_token', token, CookiePresets.csrf(true));
```

## OpÃ§Ãµes de Cookies ðŸ“‹

Lista completa de opÃ§Ãµes de cookies disponÃ­veis:

```typescript
interface CookieOptions {
  domain?: string;           // DomÃ­nio do cookie
  encode?: (value: string) => string;  // Codificador customizado
  expires?: Date;            // Data de expiraÃ§Ã£o
  httpOnly?: boolean;        // Flag HTTP only
  maxAge?: number;           // Idade mÃ¡xima em segundos
  path?: string;             // Caminho do cookie
  sameSite?: 'strict' | 'lax' | 'none';  // PolÃ­tica SameSite
  secure?: boolean;          // Flag secure (apenas HTTPS)
  signed?: boolean;          // Assinar cookie
  encrypted?: boolean;       // Criptografar cookie
  priority?: 'low' | 'medium' | 'high';  // Prioridade (Chrome)
}
```

### httpOnly

Impede acesso do JavaScript (seguranÃ§a):

```typescript
jar.set('token', 'value', {
  httpOnly: true  // NÃ£o pode ser acessado via document.cookie
});
```

### secure

Apenas enviado via HTTPS:

```typescript
jar.set('token', 'value', {
  secure: true  // Apenas HTTPS
});
```

### sameSite

ProteÃ§Ã£o CSRF:

```typescript
jar.set('token', 'value', {
  sameSite: 'strict'  // Nunca enviado em requisiÃ§Ãµes cross-site
});

jar.set('token', 'value', {
  sameSite: 'lax'  // Enviado em navegaÃ§Ã£o de nÃ­vel superior
});

jar.set('token', 'value', {
  sameSite: 'none',  // Enviado em todas as requisiÃ§Ãµes
  secure: true       // Deve ser secure quando sameSite=none
});
```

### maxAge vs expires

```typescript
// Max age (relativo)
jar.set('token', 'value', {
  maxAge: 3600  // Expira em 1 hora
});

// Expires (absoluto)
jar.set('token', 'value', {
  expires: new Date('2025-12-31')
});
```

### domain e path

Controle o escopo do cookie:

```typescript
// DisponÃ­vel em todos os subdomÃ­nios
jar.set('data', 'value', {
  domain: '.example.com',  // *.example.com
  path: '/'
});

// Apenas em caminho especÃ­fico
jar.set('admin_token', 'secret', {
  path: '/admin'  // Apenas rotas /admin/*
});
```

## Exemplo Completo de Cookie ðŸŽ¯

### TypeScript

```typescript
import { Controller, Post, Body, Res } from "azurajs/decorators";
import { parseCookiesHeader, serializeCookie } from "azurajs/cookies";
import type { CookieOptions } from "azurajs/cookies";
import type { ResponseServer } from "azurajs/types";

@Controller("/api/auth")
export class AuthController {
  // Login e definir cookie de sessÃ£o
  @Post("/login")
  login(@Body() credentials: any, @Res() res: ResponseServer) {
    // Validar credenciais
    if (!isValidCredentials(credentials)) {
      return res.status(401).json({ error: "Credenciais invÃ¡lidas" });
    }
    
    // Criar sessÃ£o
    const sessionId = createSession(credentials.username);
    
    const options: CookieOptions = {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      maxAge: 24 * 60 * 60, // 24 horas
      path: "/",
      sameSite: "Strict",
    };
    
    const cookie = serializeCookie("sessionId", sessionId, options);
    res.setHeader("Set-Cookie", cookie);
    
    res.json({ success: true });
  }

  // Obter usuÃ¡rio do cookie de sessÃ£o
  @Get("/me")
  getCurrentUser(@Req() req: RequestServer, @Res() res: ResponseServer) {
    const cookies = parseCookiesHeader(req.headers.cookie || "");
    const sessionId = cookies.sessionId;
    
    if (!sessionId) {
      return res.status(401).json({ error: "NÃ£o autenticado" });
    }
    
    const user = getUserFromSession(sessionId);
    if (!user) {
      return res.status(401).json({ error: "SessÃ£o invÃ¡lida" });
    }
    
    res.json({ user });
  }

  // Logout e limpar cookie
  @Post("/logout")
  logout(@Res() res: ResponseServer) {
    // Limpar cookie definindo maxAge como 0
    const cookie = serializeCookie("sessionId", "", {
      httpOnly: true,
      maxAge: 0,
      path: "/",
    });
    
    res.setHeader("Set-Cookie", cookie);
    res.json({ success: true });
  }
}
```

### JavaScript

```javascript
const { parseCookiesHeader, serializeCookie } = require("azurajs/cookies");

// Login e definir cookie de sessÃ£o
app.post("/api/auth/login", ({ req, res }) => {
  const credentials = req.body;
  
  // Validar credenciais
  if (!isValidCredentials(credentials)) {
    return res.status(401).json({ error: "Credenciais invÃ¡lidas" });
  }
  
  // Criar sessÃ£o
  const sessionId = createSession(credentials.username);
  
  const options = {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    maxAge: 24 * 60 * 60, // 24 horas
    path: "/",
    sameSite: "Strict",
  };
  
  const cookie = serializeCookie("sessionId", sessionId, options);
  res.setHeader("Set-Cookie", cookie);
  
  res.json({ success: true });
});

// Obter usuÃ¡rio do cookie de sessÃ£o
app.get("/api/auth/me", ({ req, res }) => {
  const cookies = parseCookiesHeader(req.headers.cookie || "");
  const sessionId = cookies.sessionId;
  
  if (!sessionId) {
    return res.status(401).json({ error: "NÃ£o autenticado" });
  }
  
  const user = getUserFromSession(sessionId);
  if (!user) {
    return res.status(401).json({ error: "SessÃ£o invÃ¡lida" });
  }
  
  res.json({ user });
});

// Logout e limpar cookie
app.post("/api/auth/logout", ({ req, res }) => {
  // Limpar cookie definindo maxAge como 0
  const cookie = serializeCookie("sessionId", "", {
    httpOnly: true,
    maxAge: 0,
    path: "/",
  });
  
  res.setHeader("Set-Cookie", cookie);
  res.json({ success: true });
});
```

## Middleware de Cookie ðŸ”Œ

Crie middleware para autenticaÃ§Ã£o com cookies:

### TypeScript

```typescript
import { parseCookiesHeader } from "azurajs/cookies";
import type { RequestHandler } from "azurajs/types";

export const cookieAuthMiddleware: RequestHandler = async (req, res, next) => {
  const cookies = parseCookiesHeader(req.headers.cookie || "");
  const sessionId = cookies.sessionId;
  
  if (!sessionId) {
    res.status(401).json({ error: "NÃ£o autenticado" });
    return;
  }
  
  const user = await getUserFromSession(sessionId);
  if (!user) {
    res.status(401).json({ error: "SessÃ£o invÃ¡lida" });
    return;
  }
  
  // Anexar usuÃ¡rio Ã  requisiÃ§Ã£o
  (req as any).user = user;
  await next();
};

// Uso
app.use(cookieAuthMiddleware);
```

### JavaScript

```javascript
const { parseCookiesHeader } = require("azurajs/cookies");

const cookieAuthMiddleware = async (req, res, next) => {
  const cookies = parseCookiesHeader(req.headers.cookie || "");
  const sessionId = cookies.sessionId;
  
  if (!sessionId) {
    res.status(401).json({ error: "NÃ£o autenticado" });
    return;
  }
  
  const user = await getUserFromSession(sessionId);
  if (!user) {
    res.status(401).json({ error: "SessÃ£o invÃ¡lida" });
    return;
  }
  
  // Anexar usuÃ¡rio Ã  requisiÃ§Ã£o
  req.user = user;
  await next();
};

// Uso
app.use(cookieAuthMiddleware);
```

## MÃºltiplos Cookies ðŸªðŸª

Defina mÃºltiplos cookies de uma vez:

```typescript
@Post("/login")
login(@Body() credentials: any, @Res() res: ResponseServer) {
  const sessionId = createSession(credentials.username);
  const csrfToken = generateCSRFToken();
  
  const cookies = [
    serializeCookie("sessionId", sessionId, {
      httpOnly: true,
      secure: true,
      maxAge: 3600,
    }),
    serializeCookie("csrfToken", csrfToken, {
      httpOnly: false,  // AcessÃ­vel ao JavaScript
      secure: true,
      maxAge: 3600,
    }),
  ];
  
  res.setHeader("Set-Cookie", cookies);
  res.json({ success: true });
}
```

## Cookies Assinados ðŸ”

Assine cookies para proteÃ§Ã£o contra adulteraÃ§Ã£o:

```typescript
import { createHmac } from "crypto";

function signCookie(value: string, secret: string): string {
  const signature = createHmac("sha256", secret)
    .update(value)
    .digest("base64");
  return `${value}.${signature}`;
}

function verifyCookie(signedValue: string, secret: string): string | null {
  const [value, signature] = signedValue.split(".");
  const expectedSignature = createHmac("sha256", secret)
    .update(value)
    .digest("base64");
  
  if (signature === expectedSignature) {
    return value;
  }
  return null;
}

// Uso
@Post("/login")
login(@Body() credentials: any, @Res() res: ResponseServer) {
  const sessionId = createSession(credentials.username);
  const signedSessionId = signCookie(sessionId, process.env.COOKIE_SECRET!);
  
  const cookie = serializeCookie("sessionId", signedSessionId, {
    httpOnly: true,
    secure: true,
  });
  
  res.setHeader("Set-Cookie", cookie);
  res.json({ success: true });
}

@Get("/me")
getCurrentUser(@Req() req: RequestServer, @Res() res: ResponseServer) {
  const cookies = parseCookiesHeader(req.headers.cookie || "");
  const signedSessionId = cookies.sessionId;
  
  const sessionId = verifyCookie(signedSessionId, process.env.COOKIE_SECRET!);
  if (!sessionId) {
    return res.status(401).json({ error: "SessÃ£o invÃ¡lida" });
  }
  
  const user = getUserFromSession(sessionId);
  res.json({ user });
}
```

## Melhores PrÃ¡ticas Adicionais âœ¨

<Callout type="tip">
  **Sempre use httpOnly** para cookies sensÃ­veis (sessÃµes, tokens)
</Callout>

<Callout type="tip">
  **Use secure em produÃ§Ã£o** para garantir que cookies sejam enviados apenas via HTTPS
</Callout>

<Callout type="warn">
  **Defina expiraÃ§Ã£o apropriada** - NÃ£o mantenha sessÃµes para sempre
</Callout>

<Callout type="warn">
  **Use sameSite** para proteÃ§Ã£o CSRF
</Callout>

## Lista de VerificaÃ§Ã£o de SeguranÃ§a ðŸ’Ž

1. **Sempre use `httpOnly`** para tokens de autenticaÃ§Ã£o
2. **Habilite `secure`** em produÃ§Ã£o (HTTPS)
3. **Use `sameSite`** para proteÃ§Ã£o CSRF
4. **Assine cookies sensÃ­veis** para prevenir adulteraÃ§Ã£o
5. **Criptografe PII** (informaÃ§Ãµes pessoais identificÃ¡veis)
6. **Defina `maxAge` apropriado** para limitar exposiÃ§Ã£o
7. **Use domain/path** para limitar escopo do cookie
8. **Limpe sessÃµes expiradas** regularmente

## MigraÃ§Ã£o do Express ðŸ”„

```typescript
// Express
const cookieParser = require('cookie-parser');
app.use(cookieParser('secret'));

app.get('/set', (req, res) => {
  res.cookie('name', 'value', {
    signed: true,
    httpOnly: true
  });
});

app.get('/get', (req, res) => {
  const value = req.signedCookies.name;
  res.json({ value });
});

// AzuraJS - Mais poderoso!
import { CookieJar } from 'azurajs/cookies';
const jar = new CookieJar('secret');

app.get('/set', (req, res) => {
  const cookie = jar.set('name', 'value', {
    signed: true,
    httpOnly: true,
    encrypted: true  // âœ… Recurso extra!
  });
  res.setHeader('Set-Cookie', cookie);
});

app.get('/get', (req, res) => {
  const value = jar.get('name', true, true);  // assinado & criptografado
  res.json({ value });
});
```

Quase a mesma coisa, mas mais poderoso! ðŸŽ‰

## Exemplos ðŸ“š

Confira os exemplos completos:
- [cookies.example.ts](https://github.com/0xvin/azurajs/blob/main/examples/servers/cookies.example.ts) - Todos os recursos de cookies

## PrÃ³ximos Passos ðŸ“–

<Cards>
  <Card title="Middleware" href="middleware" description="Crie middleware de autenticaÃ§Ã£o" />
  <Card title="Tratamento de Erros" href="error-handling" description="Trate erros de auth" />
  <Card title="Exemplos" href="examples" description="Veja exemplos de uso de cookies" />
</Cards>

---

**Dica Pro**: Sempre audite seus cookies regularmente. Use DevTools do navegador â†’ AplicaÃ§Ã£o â†’ Cookies para inspecionar o que estÃ¡ sendo armazenado!
